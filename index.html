<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoreBox 2.8</title>
  <style>
    :root {
      --primary: #00cc99;
      --secondary: #00aaff;
      --accent: #ff3366;
      --dark: #0a1929;
      --darker: #071220;
      --light: #e6f7ff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: radial-gradient(circle at center, #071220, #0a0e1a);
      color: var(--light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
      overflow-x: hidden;
      font-size: 13px;
    }
    
    .cyber-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 170, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 170, 255, 0.05) 1px, transparent 1px);
      background-size: 30px 30px;
      z-index: -1;
      pointer-events: none;
    }
    
    .header {
      text-align: center;
      margin-bottom: 10px;
      width: 100%;
      max-width: 600px;
    }
    
    h1 {
      font-size: 1.8rem;
      margin: 0 0 5px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
      justify-content: center;
    }
    
    .stat-card {
      background: rgba(0, 30, 60, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      min-width: 90px;
      text-align: center;
      font-size: 12px;
    }
    
    .stat-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
      margin-top: 3px;
    }
    
    .main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      width: 100%;
    }
    
    .panel {
      background: rgba(10, 25, 41, 0.9);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      display: flex;
      flex-direction: column;
    }
    
    .panel-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: var(--secondary);
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--primary);
    }
    
    .inventory {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .slot {
      background: linear-gradient(145deg, #132a42, #0e2035);
      border: 1px solid rgba(0, 170, 255, 0.4);
      height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      user-select: none;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .slot:hover {
      transform: translateY(-2px);
      border-color: var(--secondary);
    }
    
    .slot.sell-mode {
      border-color: var(--accent) !important;
      color: var(--accent);
    }
    
    .slot.recycle-mode {
      border-color: var(--primary) !important;
      color: var(--primary);
    }
    
    .slot.critical {
      animation: glow 0.8s;
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 3px #fff; }
      50% { box-shadow: 0 0 12px gold; }
      100% { box-shadow: 0 0 3px #fff; }
    }
    
    .item-name {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
      padding: 0 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    .item-count {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 8px 0;
    }
    
    .btn {
      padding: 8px 12px;
      background: linear-gradient(145deg, var(--primary), #00b386);
      border: none;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
      font-size: 12px;
      min-width: 120px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 204, 153, 0.4);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-secondary {
      background: linear-gradient(145deg, #4a6fa5, #3a5a8a);
      color: white;
    }
    
    #logBox {
      background: rgba(7, 18, 32, 0.9);
      height: 100px;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid rgba(0, 170, 255, 0.3);
      margin-top: 10px;
      position: relative;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
      line-height: 1.3;
    }
    
    .log-controls {
      position: absolute;
      top: 5px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    
    .log-btn {
      background: rgba(0, 170, 255, 0.3);
      border: 1px solid var(--secondary);
      color: var(--light);
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 10px;
    }
    
    .upgrade {
      background: linear-gradient(145deg, #2a1a5f, #1f0f45);
      border-color: #9900ff;
    }
    
    .defense {
      background: linear-gradient(145deg, #5a1a1a, #3a0f0f);
      border-color: #ff3333;
    }
    
    .mining-bonus {
      position: absolute;
      top: 3px;
      right: 3px;
      background: rgba(0, 0, 0, 0.7);
      font-size: 9px;
      color: var(--primary);
      padding: 2px 5px;
      border-radius: 6px;
    }
    
    .upgrade-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    
    .upgrade-card {
      background: linear-gradient(145deg, #1a2a42, #0e1a30);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 170, 255, 0.4);
    }
    
    .upgrade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .upgrade-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .upgrade-level {
      background: rgba(0, 170, 255, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .progress-container {
      width: 100%;
      height: 6px;
      background: #333;
      margin: 8px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 3px;
    }
    
    .upgrade-cost {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    
    .upgrade-btn {
      background: linear-gradient(145deg, var(--primary), #00b386);
      border: none;
      color: #000;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
      min-width: 90px;
      font-size: 11px;
    }
    
    .upgrade-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .upgrade-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0, 204, 153, 0.3);
    }
    
    .ai-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: 12px;
    }
    
    .ai-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #00cc66;
      box-shadow: 0 0 6px #00cc66;
    }
    
    .ai-indicator.inactive {
      background-color: #ff3333;
      box-shadow: 0 0 6px #ff3333;
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      70% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    .upgrade-requirements {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 8px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      font-size: 11px;
    }
    
    .requirement {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .requirement-name {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .requirement-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      background: var(--dark);
      border: 1px solid var(--secondary);
    }
    
    .requirement-value {
      font-weight: bold;
    }
    
    .requirement-met {
      color: var(--primary);
    }
    
    .requirement-not-met {
      color: var(--accent);
    }
    
    .status-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .status-item {
      flex: 1;
      background: rgba(0, 30, 60, 0.6);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
    }
    
    .status-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1rem;
      margin-top: 3px;
    }
    
    .quest-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    
    .quest-card {
      background: linear-gradient(145deg, #2a1a5f, #1f0f45);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 170, 255, 0.4);
    }
    
    .quest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .quest-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .quest-reward {
      background: rgba(0, 170, 255, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
      color: gold;
    }
    
    .quest-progress-container {
      width: 100%;
      height: 6px;
      background: #333;
      margin: 8px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .quest-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #ff6699);
      border-radius: 3px;
    }
    
    .quest-description {
      font-size: 11px;
      margin-top: 6px;
      line-height: 1.3;
    }
    
    .mining-action {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    @media (max-width: 600px) {
      .inventory {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .btn {
        min-width: 100%;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      .action-buttons > div {
        flex-direction: column;
        width: 100%;
      }
      
      .action-buttons > div > button {
        width: 100%;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .status-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .log-controls {
        position: static;
        justify-content: center;
        margin-bottom: 5px;
      }
      
      .upgrade-btn {
        min-width: 100%;
        padding: 5px;
      }
      
      .upgrade-container {
        grid-template-columns: 1fr;
      }
      
      .stat-card {
        min-width: 80px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="cyber-grid"></div>

  <div class="header">
    <h1>CoreBox 2.8</h1>
    
    <div class="stats-container">
      <div class="stat-card">
        <div>–ë–∞–ª–∞–Ω—Å</div>
        <div id="currencyDisplay" class="stat-value">0‚Ç∏</div>
      </div>
      <div class="stat-card">
        <div>–í—Ä–µ–º—è</div>
        <div id="timeDisplay" class="stat-value">–î–µ–Ω—å</div>
      </div>
      <div class="stat-card">
        <div>–ó–∞—â–∏—Ç–∞</div>
        <div id="defenseDisplay" class="stat-value">0%</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</div>
      
      <div class="status-row">
        <div class="status-item">
          <div>–ò–ò</div>
          <div id="aiStatusText" class="status-value">–ê–∫—Ç–∏–≤–µ–Ω</div>
        </div>
        <div class="status-item">
          <div>–¢–≠–¶</div>
          <div id="coalStatus" class="status-value">–í—ã–∫–ª</div>
        </div>
        <div class="status-item">
          <div>–ü–æ–≤—Å—Ç–∞–Ω—Ü—ã</div>
          <div id="rebelStatus" class="status-value">–ù–∏–∑–∫–∏–π</div>
        </div>
      </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ —Å—é–¥–∞ -->
    <div class="mining-action">
      <button id="mineBtn" class="btn pulse">–î–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã <span id="miningBonus">+0%</span></button>
    </div>
    
    <div class="panel">
      <div class="panel-title">–°–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª</div>
      <div id="logBox">
        <div class="log-controls">
          <button id="clearLogBtn" class="log-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="autoScrollBtn" class="log-btn">–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª</button>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      
      <div class="inventory" id="inventory"></div>
      
      <div class="action-buttons">
        <div style="display: flex; gap: 8px; width: 100%;">
          <button id="toggleTrade" class="btn btn-secondary">–¢–æ—Ä–≥–æ–≤–ª—è</button>
          <button id="toggleRecycle" class="btn btn-secondary">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</button>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">–°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–ø–≥—Ä–µ–π–¥—ã</div>
      
      <div class="upgrade-container">
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ–±—ã—á–∏</div>
            <div class="upgrade-level">–£—Ä. <span id="miningLevel">0</span>/10</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" id="miningProgress" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">üéõÔ∏è</div>
                <span>–ß–∏–ø—ã:</span>
              </div>
              <div class="requirement-value" id="miningChipsReq">0/5</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeMiningBtn" class="upgrade-btn">–£–ª—É—á—à–∏—Ç—å</button>
          </div>
        </div>
        
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">–¢—É—Ä—Ä–µ–ª–∏ –∑–∞—â–∏—Ç—ã</div>
            <div class="upgrade-level" id="defenseStatus">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">üíæ</div>
                <span>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞:</span>
              </div>
              <div class="requirement-value" id="defenseElectronicsReq">0/3</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeDefenseBtn" class="upgrade-btn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
        
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã</div>
            <div class="upgrade-level" id="defenseLevel">–£—Ä. 0/5</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">üéõÔ∏è</div>
                <span>–ß–∏–ø—ã:</span>
              </div>
              <div class="requirement-value" id="defenseChipsReq">0/10</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeDefenseLevelBtn" class="upgrade-btn">–£–ª—É—á—à–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">–ó–∞–¥–∞–Ω–∏—è</div>
      <div class="quest-container" id="questsContainer">
        <!-- –ö–≤–µ—Å—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
      const STORAGE_KEY = 'coreboxSave2.8';
      const maxSlots = 9;
      
      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
      const inventory = { 
        '–ò–ò': 1, 
        '–£–≥–æ–ª—å': 0, 
        '–ú—É—Å–æ—Ä': 0,
        '–ß–∏–ø—ã': 0,
        '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞': 0
      };
      
      const upgrades = {
        mining: 0,
        defense: false,
        defenseLevel: 0
      };
      
      let tng = 0;
      let coalEnabled = false;
      let gameTime = 30;
      let isDay = true;
      let passiveCounter = 0;
      let sellMode = false;
      let recycleMode = false;
      let trashSold = 0;
      let criticalMining = false;
      let autoScrollEnabled = true;
      let quests = [];
      let rebelActivity = 0;
      let lastUpdateTime = Date.now();

      // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
      const currencyDisplay = document.getElementById('currencyDisplay');
      const timeDisplay = document.getElementById('timeDisplay');
      const defenseDisplay = document.getElementById('defenseDisplay');
      const logBox = document.getElementById('logBox');
      const inventoryDiv = document.getElementById('inventory');
      const aiStatusText = document.getElementById('aiStatusText');
      const coalStatus = document.getElementById('coalStatus');
      const rebelStatus = document.getElementById('rebelStatus');
      const mineBtn = document.getElementById('mineBtn');
      const miningBonusSpan = document.getElementById('miningBonus');
      const toggleTradeBtn = document.getElementById('toggleTrade');
      const toggleRecycleBtn = document.getElementById('toggleRecycle');
      const miningLevel = document.getElementById('miningLevel');
      const miningProgress = document.getElementById('miningProgress');
      const upgradeMiningBtn = document.getElementById('upgradeMiningBtn');
      const defenseStatus = document.getElementById('defenseStatus');
      const upgradeDefenseBtn = document.getElementById('upgradeDefenseBtn');
      const defenseLevel = document.getElementById('defenseLevel');
      const upgradeDefenseLevelBtn = document.getElementById('upgradeDefenseLevelBtn');
      const miningChipsReq = document.getElementById('miningChipsReq');
      const defenseElectronicsReq = document.getElementById('defenseElectronicsReq');
      const defenseChipsReq = document.getElementById('defenseChipsReq');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const autoScrollBtn = document.getElementById('autoScrollBtn');
      const questsContainer = document.getElementById('questsContainer');

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function log(message) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `> ${message}`;
        logBox.appendChild(entry);
        
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
      }
      
      function updateTimeDisplay() {
        const icon = isDay ? '‚òÄÔ∏è' : 'üåô';
        timeDisplay.textContent = `${isDay ? '–î–µ–Ω—å' : '–ù–æ—á—å'} ${icon} (${gameTime}s)`;
      }

      function updateCurrencyDisplay() {
        currencyDisplay.textContent = `${tng}‚Ç∏`;
      }
      
      function updateDefenseDisplay() {
        const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
        defenseDisplay.textContent = `${defensePower}%`;
      }

      // –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      function saveGame() {
        const saveData = {
          inventory,
          tng,
          coalEnabled,
          gameTime,
          isDay,
          passiveCounter,
          sellMode,
          recycleMode,
          trashSold,
          upgrades,
          autoScrollEnabled,
          quests,
          rebelActivity,
          lastUpdateTime: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
      }

      function loadGame() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            Object.keys(inventory).forEach(key => {
              if (data.inventory[key] !== undefined) inventory[key] = data.inventory[key];
            });
            tng = data.tng ?? 0;
            coalEnabled = data.coalEnabled ?? false;
            gameTime = data.gameTime ?? 30;
            isDay = data.isDay ?? true;
            passiveCounter = data.passiveCounter ?? 0;
            sellMode = data.sellMode ?? false;
            recycleMode = data.recycleMode ?? false;
            trashSold = data.trashSold ?? 0;
            upgrades.mining = data.upgrades?.mining ?? 0;
            upgrades.defense = data.upgrades?.defense ?? false;
            upgrades.defenseLevel = data.upgrades?.defenseLevel ?? 0;
            autoScrollEnabled = data.autoScrollEnabled ?? true;
            quests = data.quests ?? [];
            rebelActivity = data.rebelActivity ?? 0;
            lastUpdateTime = data.lastUpdateTime ?? Date.now();
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', e);
          }
        }
      }

      // –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
      function calculateTrashPrice() {
        const basePrice = 1;
        const priceDrop = Math.floor(trashSold / 5) * 0.05;
        return Math.max(basePrice - priceDrop, 0.3);
      }

      function render() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å –¥–æ–±—ã—á–∏
        miningBonusSpan.textContent = `+${upgrades.mining}%`;
        miningLevel.textContent = upgrades.mining;
        miningProgress.style.width = `${upgrades.mining * 10}%`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
        coalStatus.textContent = coalEnabled ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–í—ã–∫–ª';
        defenseStatus.textContent = upgrades.defense ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–í—ã–∫–ª';
        defenseLevel.textContent = `–£—Ä. ${upgrades.defenseLevel}/5`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤
        let rebelText = '–ù–∏–∑–∫–∏–π';
        let rebelColor = '#00cc66';
        if (rebelActivity > 2) {
          rebelText = '–í—ã—Å–æ–∫–∏–π';
          rebelColor = '#ff3333';
        } else if (rebelActivity > 0) {
          rebelText = '–°—Ä–µ–¥–Ω–∏–π';
          rebelColor = '#ffcc00';
        }
        rebelStatus.textContent = rebelText;
        rebelStatus.style.color = rebelColor;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ò–ò
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ò–ò —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¢–≠–¶
        const aiActive = isDay || coalEnabled;
        aiStatusText.textContent = aiActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        aiStatusText.style.color = aiActive ? '#00cc66' : '#ff3333';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–ª—é—Ç—É –∏ –∑–∞—â–∏—Ç—É
        updateCurrencyDisplay();
        updateDefenseDisplay();
        updateTimeDisplay();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∞–ø–≥—Ä–µ–π–¥–æ–≤
        upgradeMiningBtn.disabled = upgrades.mining >= 10 || inventory['–ß–∏–ø—ã'] < 5;
        upgradeDefenseBtn.disabled = upgrades.defense || inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'] < 3;
        upgradeDefenseLevelBtn.disabled = upgrades.defenseLevel >= 5 || inventory['–ß–∏–ø—ã'] < (upgrades.defenseLevel + 1) * 10;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
        miningChipsReq.textContent = `${inventory['–ß–∏–ø—ã']}/5`;
        miningChipsReq.className = inventory['–ß–∏–ø—ã'] >= 5 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defenseElectronicsReq.textContent = `${inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞']}/3`;
        defenseElectronicsReq.className = inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'] >= 3 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defenseChipsReq.textContent = `${inventory['–ß–∏–ø—ã']}/${(upgrades.defenseLevel + 1) * 10}`;
        defenseChipsReq.className = inventory['–ß–∏–ø—ã'] >= (upgrades.defenseLevel + 1) * 10 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞
        autoScrollBtn.textContent = autoScrollEnabled ? '–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª ‚úì' : '–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª';
        
        // –û—á–∏—â–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        inventoryDiv.innerHTML = '';

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        Object.entries(inventory).forEach(([name, count]) => {
          if (name === '–ò–ò') return;
          
          const slot = document.createElement('div');
          slot.className = 'slot';
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'item-name';
          nameDiv.textContent = name;
          
          const countDiv = document.createElement('div');
          countDiv.className = 'item-count';
          countDiv.textContent = `x${count}`;
          
          slot.appendChild(nameDiv);
          slot.appendChild(countDiv);

          // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–±—ã—á–∏
          if (criticalMining && (name === '–£–≥–æ–ª—å' || name === '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞')) {
            slot.classList.add('critical');
            criticalMining = false;
          }
          
          // –ë–æ–Ω—É—Å—ã –¥–æ–±—ã—á–∏
          if (name === '–£–≥–æ–ª—å' || name === '–ú—É—Å–æ—Ä') {
            const bonusDiv = document.createElement('div');
            bonusDiv.className = 'mining-bonus';
            const baseChance = name === '–£–≥–æ–ª—å' ? 3 : 1.5;
            const totalBonus = upgrades.mining + (coalEnabled ? (name === '–£–≥–æ–ª—å' ? 2 : 1) : 0);
            bonusDiv.textContent = `+${baseChance + totalBonus}%`;
            slot.appendChild(bonusDiv);
          }

          // –†–µ–∂–∏–º –ø—Ä–æ–¥–∞–∂–∏
          if (sellMode && name === '–ú—É—Å–æ—Ä') {
            slot.classList.add('sell-mode');
            slot.onclick = () => handleSellTrash();
          } 
          // –†–µ–∂–∏–º –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
          else if (recycleMode && name === '–ú—É—Å–æ—Ä') {
            slot.classList.add('recycle-mode');
            slot.onclick = () => handleRecycleTrash();
          }
          // –£–≥–æ–ª—å
          else if (name === '–£–≥–æ–ª—å') {
            if (coalEnabled) {
              slot.style.borderColor = 'var(--primary)';
              slot.style.boxShadow = '0 0 8px var(--primary)';
            }
            
            slot.onclick = () => handleCoalInteraction();
          }
          // –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã
          else if (name === '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞' && count > 0) {
            slot.classList.add('defense');
          }

          inventoryDiv.appendChild(slot);
        });

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤
        while (inventoryDiv.children.length < maxSlots) {
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.innerHTML = '<div class="item-name">[–ü—É—Å—Ç–æ]</div><div class="item-count">+</div>';
          inventoryDiv.appendChild(slot);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
        renderQuests();
      }
      
      function renderQuests() {
        questsContainer.innerHTML = '';
        
        if (quests.length === 0) {
          const emptyQuest = document.createElement('div');
          emptyQuest.className = 'quest-card';
          emptyQuest.innerHTML = `
            <div class="quest-description">
              –ó–∞–¥–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–æ–±—ã—á—É —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π.
            </div>
          `;
          questsContainer.appendChild(emptyQuest);
          return;
        }
        
        quests.forEach(quest => {
          const questCard = document.createElement('div');
          questCard.className = 'quest-card';
          
          const progressPercent = Math.min(100, (quest.progress / quest.target) * 100);
          
          questCard.innerHTML = `
            <div class="quest-header">
              <div class="quest-title">${quest.title}</div>
              <div class="quest-reward">${quest.reward}‚Ç∏</div>
            </div>
            <div class="quest-progress-container">
              <div class="quest-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="quest-description">
              ${quest.description}<br>
              –ü—Ä–æ–≥—Ä–µ—Å—Å: ${quest.progress}/${quest.target}
            </div>
          `;
          
          questsContainer.appendChild(questCard);
        });
      }
      
      function checkQuests() {
        quests.forEach(quest => {
          if (quest.completed) return;
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞
          if (quest.type === 'mine') {
            if (quest.progress >= quest.target) {
              completeQuest(quest.id);
            }
          }
          else if (quest.type === 'sell') {
            if (inventory['–ú—É—Å–æ—Ä'] >= quest.target) {
              completeQuest(quest.id);
            }
          }
          else if (quest.type === 'upgrade') {
            if (upgrades.mining >= quest.target) {
              completeQuest(quest.id);
            }
          }
        });
      }
      
      function completeQuest(questId) {
        const questIndex = quests.findIndex(q => q.id === questId);
        if (questIndex !== -1) {
          const quest = quests[questIndex];
          tng += quest.reward;
          quest.completed = true;
          
          log(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ "${quest.title}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${quest.reward}‚Ç∏`);
          quests.splice(questIndex, 1);
          
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
          generateNewQuest();
          
          updateCurrencyDisplay();
          saveGame();
          render();
        }
      }
      
      function generateNewQuest() {
        if (quests.length >= 3) return;
        
        const questTypes = ['mine', 'sell', 'upgrade'];
        const type = questTypes[Math.floor(Math.random() * questTypes.length)];
        
        let quest;
        switch(type) {
          case 'mine':
            const resources = ['–£–≥–æ–ª—å', '–ú—É—Å–æ—Ä', '–ß–∏–ø—ã', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'];
            const resource = resources[Math.floor(Math.random() * resources.length)];
            const target = Math.max(3, Math.floor(Math.random() * 10) + 3);
            
            quest = {
              id: `mine_${Date.now()}`,
              title: '–î–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã',
              description: `–î–æ–±—ã—Ç—å ${target} ${resource}`,
              type: 'mine',
              resource: resource,
              target: target,
              progress: inventory[resource] || 0,
              reward: target * 2,
              completed: false
            };
            break;
            
          case 'sell':
            const sellTarget = Math.max(5, Math.floor(Math.random() * 15) + 5);
            
            quest = {
              id: `sell_${Date.now()}`,
              title: '–ü—Ä–æ–¥–∞—Ç—å –º—É—Å–æ—Ä',
              description: `–ü—Ä–æ–¥–∞—Ç—å ${sellTarget} –º—É—Å–æ—Ä–∞ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑`,
              type: 'sell',
              target: sellTarget,
              progress: 0,
              reward: sellTarget * 1.5,
              completed: false
            };
            break;
            
          case 'upgrade':
            const upgradeTarget = Math.min(10, Math.max(1, upgrades.mining + Math.floor(Math.random() * 2) + 1));
            
            quest = {
              id: `upgrade_${Date.now()}`,
              title: '–£–ª—É—á—à–∏—Ç—å –¥–æ–±—ã—á—É',
              description: `–£–ª—É—á—à–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ–±—ã—á–∏ –¥–æ —É—Ä–æ–≤–Ω—è ${upgradeTarget}`,
              type: 'upgrade',
              target: upgradeTarget,
              progress: upgrades.mining,
              reward: upgradeTarget * 5,
              completed: false
            };
            break;
        }
        
        quests.push(quest);
        log(`üÜï –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ${quest.title}`);
      }
      
      function handleRebelAttack() {
        // –£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤
        const threatLevel = Math.min(1, rebelActivity * 0.2);
        
        if (Math.random() < threatLevel) {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞—Ç–∞–∫–∏
          const attackType = Math.floor(Math.random() * 3);
          let message = "üåô –ü–æ–≤—Å—Ç–∞–Ω—Ü—ã –∞—Ç–∞–∫–æ–≤–∞–ª–∏!";
          
          switch(attackType) {
            case 0: // –ö—Ä–∞–∂–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
              const resources = Object.keys(inventory).filter(k => k !== '–ò–ò' && inventory[k] > 0);
              if (resources.length > 0) {
                const stolenResource = resources[Math.floor(Math.random() * resources.length)];
                const amount = Math.min(inventory[stolenResource], Math.floor(Math.random() * 3) + 1);
                inventory[stolenResource] -= amount;
                message += ` –£–∫—Ä–∞–¥–µ–Ω–æ ${amount} ${stolenResource}`;
              }
              break;
              
            case 1: // –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
              if (upgrades.mining > 0 && Math.random() < 0.3) {
                upgrades.mining--;
                message += " –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–±—ã—á–∏! –£—Ä–æ–≤–µ–Ω—å –ø–æ–Ω–∏–∂–µ–Ω";
              }
              break;
              
            case 2: // –í–∞–Ω–¥–∞–ª–∏–∑–º
              if (inventory['–ú—É—Å–æ—Ä'] > 0) {
                const destroyed = Math.min(inventory['–ú—É—Å–æ—Ä'], Math.floor(Math.random() * 5) + 3);
                inventory['–ú—É—Å–æ—Ä'] -= destroyed;
                message += ` –£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ ${destroyed} –º—É—Å–æ—Ä–∞`;
              }
              break;
          }
          
          log(message);
          rebelActivity++;
          saveGame();
        }
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
      function handleSellTrash() {
        if (inventory['–ú—É—Å–æ—Ä'] > 0) {
          const price = calculateTrashPrice();
          const earned = Math.floor(inventory['–ú—É—Å–æ—Ä'] * price);
          tng += earned;
          trashSold += inventory['–ú—É—Å–æ—Ä'];
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É
          quests.forEach(quest => {
            if (quest.type === 'sell' && inventory['–ú—É—Å–æ—Ä'] >= quest.target) {
              quest.progress = inventory['–ú—É—Å–æ—Ä'];
            }
          });
          
          log(`–ü—Ä–æ–¥–∞–Ω–æ ${inventory['–ú—É—Å–æ—Ä']} –º—É—Å–æ—Ä–∞ +${earned}‚Ç∏`);
          inventory['–ú—É—Å–æ—Ä'] = 0;
          updateCurrencyDisplay();
          saveGame();
          render();
          checkQuests();
        }
      }

      function handleRecycleTrash() {
        if (inventory['–ú—É—Å–æ—Ä'] >= 5) {
          inventory['–ú—É—Å–æ—Ä'] -= 5;
          inventory['–£–≥–æ–ª—å']++;
          
          log('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ 5 –º—É—Å–æ—Ä–∞ ‚Üí 1 —É–≥–æ–ª—å');
          saveGame();
          render();
        }
      }

      function handleCoalInteraction() {
        if (sellMode && isDay) {
          if (inventory['–£–≥–æ–ª—å'] > 0) {
            inventory['–£–≥–æ–ª—å']--;
            tng += 3;
            coalEnabled = false;
            
            log('–ü—Ä–æ–¥–∞–Ω–æ 1 —É–≥–æ–ª—å +3‚Ç∏ (–¢–≠–¶ –æ—Ç–∫–ª—é—á–µ–Ω–∞)');
            updateCurrencyDisplay();
            saveGame();
            render();
          }
        } 
        else if (!sellMode && !recycleMode) {
          if (!coalEnabled) {
            if (inventory['–£–≥–æ–ª—å'] > 0) {
              coalEnabled = true;
              inventory['–£–≥–æ–ª—å']--;
              
              log('–£–≥–æ–ª—å–Ω–∞—è –¢–≠–¶ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (-1 —É–≥–æ–ª—å)');
            } else {
              log('–ù–µ—Ç —É–≥–ª—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!');
            }
          } else {
            coalEnabled = false;
            log('–£–≥–æ–ª—å–Ω–∞—è –¢–≠–¶ –æ—Ç–∫–ª—é—á–µ–Ω–∞');
          }
          saveGame();
          render();
        }
      }

      function mineResources() {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ò–ò –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¢–≠–¶
        const aiActive = isDay || coalEnabled;
        if (!aiActive) {
          log('‚ùå –ò–ò –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω! –ù—É–∂–Ω–∞ —ç–Ω–µ—Ä–≥–∏—è');
          return;
        }
        
        // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±—ã—á–∏
        const coalChance = 0.02 + (coalEnabled ? 0.02 : 0) + (upgrades.mining * 0.01);
        const trashChance = 0.01 + (coalEnabled ? 0.01 : 0) + (upgrades.mining * 0.01);
        const chipChance = 0.005;
        const electronicsChance = 0.003;
        const isCritical = Math.random() < 0.05;

        let foundSomething = false;

        if (Math.random() < coalChance) {
          const amount = isCritical ? 2 : 1;
          inventory['–£–≥–æ–ª—å'] += amount;
          criticalMining = isCritical;
          
          log(`–ù–∞–π–¥–µ–Ω${amount > 1 ? '–æ' : ''} ${amount} —É–≥–ª—è ü™®${isCritical ? ' ‚ú®' : ''}`);
          foundSomething = true;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –¥–æ–±—ã—á—É —É–≥–ª—è
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === '–£–≥–æ–ª—å') {
              quest.progress += amount;
            }
          });
        }
        
        if (Math.random() < trashChance) {
          inventory['–ú—É—Å–æ—Ä']++;
          log('–ù–∞–π–¥–µ–Ω –º—É—Å–æ—Ä ‚ôªÔ∏è');
          foundSomething = true;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –¥–æ–±—ã—á—É –º—É—Å–æ—Ä–∞
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === '–ú—É—Å–æ—Ä') {
              quest.progress++;
            }
          });
        }
        
        if (Math.random() < chipChance) {
          inventory['–ß–∏–ø—ã']++;
          criticalMining = true;
          log('–ù–∞–π–¥–µ–Ω —á–∏–ø üéõÔ∏è‚ú®');
          foundSomething = true;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –¥–æ–±—ã—á—É —á–∏–ø–æ–≤
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === '–ß–∏–ø—ã') {
              quest.progress++;
            }
          });
        }
        
        if (Math.random() < electronicsChance) {
          inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞']++;
          criticalMining = true;
          log('–ù–∞–π–¥–µ–Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ üíæ‚ú®');
          foundSomething = true;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –¥–æ–±—ã—á—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞') {
              quest.progress++;
            }
          });
        }
        
        saveGame();
        render();
        checkQuests();
      }
      
      function upgradeMining() {
        if (upgrades.mining < 10 && inventory['–ß–∏–ø—ã'] >= 5) {
          inventory['–ß–∏–ø—ã'] -= 5;
          upgrades.mining++;
          
          log(`–£–ª—É—á—à–µ–Ω–∞ –¥–æ–±—ã—á–∞! –¢–µ–ø–µ—Ä—å +${upgrades.mining}% –∫ —à–∞–Ω—Å–∞–º`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –Ω–∞ –∞–ø–≥—Ä–µ–π–¥—ã
          quests.forEach(quest => {
            if (quest.type === 'upgrade') {
              quest.progress = upgrades.mining;
            }
          });
          
          saveGame();
          render();
          checkQuests();
        }
      }
      
      function activateDefense() {
        if (!upgrades.defense && inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'] >= 3) {
          inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'] -= 3;
          upgrades.defense = true;
          
          log('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã —Ç—É—Ä—Ä–µ–ª–∏ –∑–∞—â–∏—Ç—ã!');
          saveGame();
          render();
        }
      }
      
      function upgradeDefense() {
        if (upgrades.defenseLevel < 5 && inventory['–ß–∏–ø—ã'] >= (upgrades.defenseLevel + 1) * 10) {
          const cost = (upgrades.defenseLevel + 1) * 10;
          inventory['–ß–∏–ø—ã'] -= cost;
          upgrades.defenseLevel++;
          
          log(`–£–ª—É—á—à–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${upgrades.defenseLevel}!`);
          saveGame();
          render();
        }
      }
      
      function clearLog() {
        logBox.innerHTML = '<div class="log-controls"><button id="clearLogBtn" class="log-btn">–û—á–∏—Å—Ç–∏—Ç—å</button><button id="autoScrollBtn" class="log-btn">–ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª</button></div>';
        log('–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω');
      }
      
      function toggleAutoScroll() {
        autoScrollEnabled = !autoScrollEnabled;
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
        saveGame();
        render();
      }

      // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
      function gameLoop() {
        const now = Date.now();
        const secondsPassed = Math.floor((now - lastUpdateTime) / 1000);
        lastUpdateTime = now;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–µ–∫—É–Ω–¥
        gameTime -= secondsPassed;
        
        while (gameTime <= 0) {
          gameTime += 30;
          isDay = !isDay;
          
          if (!isDay) {
            if (coalEnabled) {
              if (inventory['–£–≥–æ–ª—å'] > 0) {
                inventory['–£–≥–æ–ª—å']--;
                log('üåô –ù–æ—á—å - —Å–≥–æ—Ä–µ–ª 1 —É–≥–æ–ª—å');
              } else {
                coalEnabled = false;
                log('üåô –ù–æ—á—å - —É–≥–æ–ª—å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –¢–≠–¶ –æ—Ç–∫–ª—é—á–µ–Ω–∞');
              }
            }
            
            // –ê—Ç–∞–∫–∞ –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤
            if (!isDay) {
              const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
              if (Math.random() * 100 > defensePower) {
                handleRebelAttack();
              } else if (upgrades.defense) {
                log('üåô –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç—Ä–∞–∑–∏–ª–∞ –∞—Ç–∞–∫—É –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤');
              }
              
              // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤
              if (Math.random() < 0.3) {
                rebelActivity++;
              }
            }
          } else {
            // –°–Ω–∏–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤ –¥–Ω–µ–º
            rebelActivity = Math.max(0, rebelActivity - 1);
          }
          
          log(isDay ? '‚òÄÔ∏è –ù–∞—Å—Ç—É–ø–∏–ª –¥–µ–Ω—å' : 'üåô –ù–∞—Å—Ç—É–ø–∏–ª–∞ –Ω–æ—á—å');
          
          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–≤–µ—Å—Ç–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è
          if (isDay && quests.length < 3 && Math.random() < 0.5) {
            generateNewQuest();
          }
          
          saveGame();
        }

        // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–µ–∫—É–Ω–¥)
        passiveCounter += secondsPassed;
        while (passiveCounter >= 10) {
          passiveCounter -= 10;
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ò–ò —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¢–≠–¶
          const aiActive = isDay || coalEnabled;
          if (aiActive) {
            const coalChance = 0.003 + (upgrades.mining * 0.001);
            const trashChance = 0.007 + (upgrades.mining * 0.001);
            const chipChance = 0.001;
            const electronicsChance = 0.0005;
            
            if (Math.random() < coalChance) {
              inventory['–£–≥–æ–ª—å']++;
            }
            if (Math.random() < trashChance) {
              inventory['–ú—É—Å–æ—Ä']++;
            }
            if (Math.random() < chipChance) {
              inventory['–ß–∏–ø—ã']++;
            }
            if (Math.random() < electronicsChance) {
              inventory['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞']++;
            }
            
            saveGame();
          }
        }

        render();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
      function initEventListeners() {
        mineBtn.addEventListener('click', mineResources);
        toggleTradeBtn.addEventListener('click', toggleTradeMode);
        toggleRecycleBtn.addEventListener('click', toggleRecycleMode);
        upgradeMiningBtn.addEventListener('click', upgradeMining);
        upgradeDefenseBtn.addEventListener('click', activateDefense);
        upgradeDefenseLevelBtn.addEventListener('click', upgradeDefense);
        clearLogBtn.addEventListener('click', clearLog);
        autoScrollBtn.addEventListener('click', toggleAutoScroll);
      }

      function toggleTradeMode() {
        sellMode = !sellMode;
        if (sellMode) recycleMode = false;
        log(sellMode ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏' : '–†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω');
        saveGame();
        render();
      }

      function toggleRecycleMode() {
        recycleMode = !recycleMode;
        if (recycleMode) sellMode = false;
        log(recycleMode ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏' : '–†–µ–∂–∏–º –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω');
        saveGame();
        render();
      }

      // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
      function initGame() {
        loadGame();
        initEventListeners();
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
        if (quests.length === 0) {
          generateNewQuest();
          generateNewQuest();
        }
        
        render();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
        setInterval(gameLoop, 1000);
        
        log('–°–∏—Å—Ç–µ–º–∞ CoreBox 2.8 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        log('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤!');
        log('–û—Å—Ç–µ—Ä–µ–≥–∞–π—Ç–µ—Å—å –ø–æ–≤—Å—Ç–∞–Ω—Ü–µ–≤-–∞–Ω–∞—Ä—Ö–∏—Å—Ç–æ–≤ –ø–æ –Ω–æ—á–∞–º!');
      }

      initGame();
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CoreBox 2.9</title>
  <style>
    :root {
      --primary: #00aa80;
      --secondary: #0088cc;
      --accent: #ff2255;
      --gold: #ffcc00;
      --dark: #081625;
      --darker: #050d18;
      --light: #d0e7ff;
      --panel-bg: rgba(8, 22, 41, 0.92);
      --plasma: #9d4edd;
      --slot-size: 64px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: radial-gradient(circle at center, #050d18, #080c15);
      color: var(--light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
      overflow-x: hidden;
      font-size: 13px;
    }
    
    .cyber-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 120, 200, 0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 120, 200, 0.06) 1px, transparent 1px);
      background-size: 30px 30px;
      z-index: -1;
      pointer-events: none;
    }
    
    .header {
      text-align: center;
      margin-bottom: 10px;
      width: 100%;
      max-width: 600px;
    }
    
    h1 {
      font-size: 1.8rem;
      margin: 0 0 5px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
      text-shadow: 0 0 8px rgba(0, 170, 255, 0.3);
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
      justify-content: center;
    }
    
    .stat-card {
      background: rgba(0, 20, 40, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0, 120, 200, 0.4);
      min-width: 90px;
      text-align: center;
      font-size: 12px;
    }
    
    .stat-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
      margin-top: 3px;
    }
    
    .main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      width: 100%;
    }
    
    .panel {
      background: var(--panel-bg);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0, 120, 200, 0.4);
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    
    .panel.collapsed {
      padding: 8px 12px;
    }
    
    .panel-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: var(--secondary);
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .panel-title .collapse-icon {
      font-size: 14px;
      transition: transform 0.3s;
    }
    
    .panel.collapsed .panel-title .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .panel-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .panel.collapsed .panel-content {
      height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
    
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(6, var(--slot-size));
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
    }
    
    .slot {
      background: linear-gradient(145deg, #0f2235, #0b1a2a);
      border: 1px solid rgba(0, 120, 200, 0.4);
      width: var(--slot-size);
      height: var(--slot-size);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      user-select: none;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .slot:hover {
      transform: translateY(-2px);
      border-color: var(--secondary);
      box-shadow: 0 4px 8px rgba(0, 120, 200, 0.3);
    }
    
    .slot.critical {
      animation: glow 0.8s;
    }
    
    .slot.plasma {
      border-color: var(--plasma) !important;
      box-shadow: 0 0 10px var(--plasma);
    }
    
    .slot.empty {
      opacity: 0.6;
      background: rgba(15, 34, 53, 0.4);
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 3px #fff; }
      50% { box-shadow: 0 0 12px gold; }
      100% { box-shadow: 0 0 3px #fff; }
    }
    
    .item-name {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 10px;
      padding: 0 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      line-height: 1.1;
    }
    
    .item-count {
      font-size: 14px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      justify-content: center;
      margin-top: 5px;
    }
    
    .btn {
      padding: 8px 5px;
      background: linear-gradient(145deg, var(--primary), #009973);
      border: none;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
      font-size: 11px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 170, 153, 0.4);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    #logBox {
      background: rgba(6, 15, 28, 0.9);
      height: 100px;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid rgba(0, 120, 200, 0.3);
      margin-top: 10px;
      position: relative;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(200, 220, 255, 0.1);
      line-height: 1.3;
    }
    
    .log-controls {
      display: flex;
      gap: 5px;
    }
    
    .log-btn {
      background: rgba(0, 120, 200, 0.3);
      border: 1px solid var(--secondary);
      color: var(--light);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .log-btn:hover {
      background: rgba(0, 140, 230, 0.4);
    }
    
    .upgrade-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    
    .upgrade-card {
      background: linear-gradient(145deg, #142235, #0b1525);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 120, 200, 0.4);
    }
    
    .upgrade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .upgrade-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .upgrade-level {
      background: rgba(0, 120, 200, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .progress-container {
      width: 100%;
      height: 6px;
      background: #222;
      margin: 8px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 3px;
    }
    
    .upgrade-cost {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    
    .upgrade-btn {
      background: linear-gradient(145deg, var(--primary), #009973);
      border: none;
      color: #000;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
      min-width: 90px;
      font-size: 11px;
    }
    
    .upgrade-btn:disabled {
      background: #444;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .upgrade-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0, 170, 153, 0.3);
    }
    
    .status-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .status-item {
      flex: 1;
      background: rgba(0, 20, 40, 0.6);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
    }
    
    .ai-status-item {
      flex: 1;
      background: rgba(0, 30, 60, 0.7);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      box-shadow: 0 0 8px rgba(0, 170, 255, 0.2);
    }
    
    .status-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1rem;
      margin-top: 3px;
    }
    
    .ai-status-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
      margin-top: 3px;
      text-shadow: 0 0 6px rgba(0, 200, 255, 0.5);
    }
    
    .quest-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    
    .quest-card {
      background: linear-gradient(145deg, #221550, #180a35);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 120, 200, 0.4);
    }
    
    .quest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .quest-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .quest-reward {
      background: rgba(0, 120, 200, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
      color: gold;
    }
    
    .quest-description {
      font-size: 11px;
      margin-top: 6px;
      line-height: 1.3;
    }
    
    .mining-action {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .tabs {
      display: flex;
      background: var(--panel-bg);
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      margin-top: 15px;
      border: 1px solid rgba(0, 120, 200, 0.4);
      border-bottom: none;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      background: rgba(0, 20, 40, 0.6);
      transition: all 0.3s;
      font-weight: 600;
      border-right: 1px solid rgba(0, 120, 200, 0.4);
    }
    
    .tab:last-child {
      border-right: none;
    }
    
    .tab.active {
      background: rgba(0, 120, 200, 0.4);
      color: var(--light);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .trade-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    
    .trade-mode-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .trade-mode-btn {
      padding: 8px 12px;
      background: rgba(0, 20, 40, 0.6);
      border: 1px solid var(--secondary);
      color: var(--light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .trade-mode-btn.active {
      background: var(--secondary);
      color: white;
    }
    
    .trade-items-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .trade-item {
      background: rgba(0, 20, 40, 0.6);
      border-radius: 6px;
      padding: 8px;
      border: 1px solid rgba(0, 120, 200, 0.4);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .trade-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 120, 200, 0.3);
    }
    
    .trade-item-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .trade-item-price {
      color: var(--primary);
      font-weight: bold;
    }
    
    .trade-item-amount {
      font-size: 11px;
      opacity: 0.8;
    }

    .radio-player {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 120px;
      background: var(--panel-bg);
      border-radius: 6px;
      padding: 6px;
      border: 1px solid rgba(0, 120, 200, 0.4);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      z-index: 100;
    }

    .radio-title {
      font-size: 10px;
      margin-bottom: 4px;
      color: var(--secondary);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .radio-controls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .radio-btn {
      background: var(--secondary);
      border: none;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 10px;
    }

    .radio-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }

    .volume-control {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
    }

    .volume-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 3px;
      background: rgba(0, 120, 200, 0.4);
      border-radius: 2px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 8px;
      height: 8px;
      background: var(--secondary);
      border-radius: 50%;
      cursor: pointer;
    }
    
    @media (max-width: 600px) {
      :root {
        --slot-size: 56px;
      }
      
      .inventory-grid {
        grid-template-columns: repeat(3, var(--slot-size));
      }
      
      .btn {
        min-width: 100%;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .status-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .log-controls {
        position: static;
        justify-content: center;
        margin-bottom: 5px;
      }
      
      .upgrade-btn {
        min-width: 100%;
        padding: 5px;
      }
      
      .upgrade-container {
        grid-template-columns: 1fr;
      }
      
      .stat-card {
        min-width: 80px;
        padding: 6px 8px;
      }
      
      .tab {
        font-size: 11px;
        padding: 8px 5px;
      }
      
      .trade-items-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .radio-player {
        width: 110px;
        right: 5px;
        bottom: 5px;
        padding: 5px;
      }
      
      .radio-controls {
        gap: 4px;
      }
      
      .radio-btn {
        width: 20px;
        height: 20px;
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <div class="cyber-grid"></div>

  <div class="radio-player">
    <div class="radio-title">SpriteLayer Radio</div>
    <div class="radio-controls">
      <button id="playBtn" class="radio-btn">▶</button>
      <button id="pauseBtn" class="radio-btn">⏸</button>
    </div>
    <div class="volume-control">
      <span>🔈</span>
      <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
    </div>
  </div>

  <div class="header">
    <h1>CoreBox 2.9</h1>
    
    <div class="stats-container">
      <div class="stat-card">
        <div>Баланс</div>
        <div id="currencyDisplay" class="stat-value">0₸</div>
      </div>
      <div class="stat-card">
        <div>Время</div>
        <div id="timeDisplay" class="stat-value">День ☀️</div>
      </div>
      <div class="stat-card">
        <div>Защита</div>
        <div id="defenseDisplay" class="stat-value">0%</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-title">
        <span>Состояние системы</span>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="panel-content">
        <div class="status-row">
          <div class="status-item">
            <div>ТЭЦ</div>
            <div id="coalStatus" class="status-value">Выкл</div>
          </div>
          <div class="ai-status-item">
            <div>Искусственный Интеллект</div>
            <div id="aiStatusText" class="ai-status-value">Активен</div>
          </div>
          <div class="status-item">
            <div>Повстанцы</div>
            <div id="rebelStatus" class="status-value">Низкий</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mining-action">
      <button id="mineBtn" class="btn pulse">Добыть ресурсы <span id="miningBonus">+0%</span></button>
    </div>
    
    <div class="panel">
      <div class="panel-title">
        <span>Системный журнал</span>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="panel-content">
        <div class="log-controls">
          <button id="clearLogBtn" class="log-btn">Очистить</button>
          <button id="autoScrollBtn" class="log-btn">Автоскролл</button>
        </div>
        <div id="logBox"></div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="inventory">Инвентарь</div>
      <div class="tab" data-tab="upgrades">Апгрейды</div>
      <div class="tab" data-tab="trade">Торговля</div>
      <div class="tab" data-tab="quests">Задания</div>
    </div>
    
    <div class="tab-content active" id="inventory-tab">
      <div class="panel">
        <div class="panel-title">
          <span>Инвентарь</span>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="panel-content">
          <div class="inventory-grid" id="inventory"></div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="upgrades-tab">
      <div class="panel">
        <div class="panel-title">
          <span>Системные апгрейды</span>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="panel-content">
          <div class="upgrade-container">
            <div class="upgrade-card">
              <div class="upgrade-header">
                <div class="upgrade-title">Эффективность добычи</div>
                <div class="upgrade-level">Ур. <span id="miningLevel">0</span>/10</div>
              </div>
              <div class="progress-container">
                <div class="progress-fill" id="miningProgress" style="width: 0%"></div>
              </div>
              
              <div class="upgrade-requirements">
                <div class="requirement">
                  <div class="requirement-name">
                    <div class="requirement-icon">🎛️</div>
                    <span>Чипы:</span>
                  </div>
                  <div class="requirement-value" id="miningChipsReq">0/5</div>
                </div>
              </div>
              
              <div class="upgrade-cost">
                <button id="upgradeMiningBtn" class="upgrade-btn">Улучшить</button>
              </div>
            </div>
            
            <div class="upgrade-card">
              <div class="upgrade-header">
                <div class="upgrade-title">Туррели защиты</div>
                <div class="upgrade-level" id="defenseStatus">Неактивно</div>
              </div>
              <div class="progress-container">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
              
              <div class="upgrade-requirements">
                <div class="requirement">
                  <div class="requirement-name">
                    <div class="requirement-icon">⚡</div>
                    <span>Плазма:</span>
                  </div>
                  <div class="requirement-value" id="defensePlasmaReq">0/3</div>
                </div>
              </div>
              
              <div class="upgrade-cost">
                <button id="upgradeDefenseBtn" class="upgrade-btn">Активировать</button>
              </div>
            </div>
            
            <div class="upgrade-card">
              <div class="upgrade-header">
                <div class="upgrade-title">Укрепление защиты</div>
                <div class="upgrade-level" id="defenseLevel">Ур. 0/5</div>
              </div>
              <div class="progress-container">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
              
              <div class="upgrade-requirements">
                <div class="requirement">
                  <div class="requirement-name">
                    <div class="requirement-icon">🎛️</div>
                    <span>Чипы:</span>
                  </div>
                  <div class="requirement-value" id="defenseChipsReq">0/10</div>
                </div>
                <div class="requirement">
                  <div class="requirement-name">
                    <div class="requirement-icon">⚡</div>
                    <span>Плазма:</span>
                  </div>
                  <div class="requirement-value" id="defensePlasmaLevelReq">0/1</div>
                </div>
              </div>
              
              <div class="upgrade-cost">
                <button id="upgradeDefenseLevelBtn" class="upgrade-btn">Улучшить</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="trade-tab">
      <div class="panel">
        <div class="panel-title">
          <span>Торговля</span>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="panel-content">
          <div class="trade-container">
            <div class="trade-mode-toggle">
              <button id="buyModeBtn" class="trade-mode-btn active">Купить</button>
              <button id="sellModeBtn" class="trade-mode-btn">Продать</button>
            </div>
            
            <div id="buyItemsContainer" class="trade-items-grid">
              <!-- Будет заполнено скриптом -->
            </div>
            
            <div id="sellItemsContainer" class="trade-items-grid" style="display: none;">
              <!-- Будет заполнено скриптом -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="quests-tab">
      <div class="panel">
        <div class="panel-title">
          <span>Задания</span>
          <span class="collapse-icon">▼</span>
        </div>
        <div class="panel-content">
          <div class="quest-container" id="questsContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Конфигурация игры
      const STORAGE_KEY = 'coreboxSave2.9';
      const maxSlots = 18;
      const CYCLE_DURATION = 45; // 45 секунд на полный цикл (день+ночь)
      
      // Состояние игры
      const inventory = { 
        'ИИ': 1, 
        'Уголь': 0, 
        'Мусор': 0,
        'Чипы': 0,
        'Плазма': 0
      };
      
      const upgrades = {
        mining: 0,
        defense: false,
        defenseLevel: 0
      };
      
      let tng = 0;
      let coalEnabled = false;
      let gameTime = CYCLE_DURATION / 2; // Начинаем с дня
      let isDay = true;
      let passiveCounter = 0;
      let trashSold = 0;
      let criticalMining = false;
      let autoScrollEnabled = true;
      let rebelActivity = 0;
      let lastUpdateTime = Date.now();
      let nightsSurvived = 0;
      let successfulDefenses = 0;
      let coalProduced = 0;
      let totalMined = 0;
      let aiDisabledUntil = 0;
      let nightsWithCoal = 0; // Счетчик ночей с активной ТЭЦ
      
      // Сюжетные задания
      const storyQuests = [
        {
          id: 'intro',
          title: 'Первые шаги',
          description: 'Добудьте любой ресурс',
          type: 'mine_any',
          target: 1,
          reward: 10,
          completed: false
        },
        {
          id: 'power_up',
          title: 'Запуск ТЭЦ',
          description: 'Активируйте угольную ТЭЦ',
          type: 'activate_coal',
          target: 1,
          reward: 15,
          completed: false
        },
        {
          id: 'first_night',
          title: 'Первая ночь',
          description: 'Переживите ночь с активной ТЭЦ',
          type: 'survive_night',
          target: 1,
          reward: 20,
          completed: false
        },
        {
          id: 'mining_upgrade',
          title: 'Улучшение добычи',
          description: 'Улучшите эффективность добычи до уровня 1',
          type: 'upgrade_mining',
          target: 1,
          reward: 25,
          completed: false
        },
        {
          id: 'plasma_discovery',
          title: 'Источник энергии',
          description: 'Добудьте 1 плазму',
          type: 'mine_resource',
          resource: 'Плазма',
          target: 1,
          reward: 30,
          completed: false
        },
        {
          id: 'defense_activate',
          title: 'Щит комплекса',
          description: 'Активируйте систему защиты',
          type: 'activate_defense',
          target: 1,
          reward: 35,
          completed: false
        },
        {
          id: 'rebel_defense',
          title: 'Отразите атаку',
          description: 'Успешно защититесь от 2 атак повстанцев',
          type: 'defend_attacks',
          target: 2,
          reward: 50,
          completed: false
        },
        {
          id: 'core_restore',
          title: 'Восстановление CoreBox',
          description: 'Накопите 3 плазмы для активации ядра',
          type: 'mine_resource',
          resource: 'Плазма',
          target: 3,
          reward: 100,
          completed: false
        }
      ];
      
      let currentQuestIndex = 0;
      
      // Торговые предметы
      const tradeItems = {
        'Уголь': { buyPrice: 5, sellPrice: 3 },
        'Чипы': { buyPrice: 15, sellPrice: 10 },
        'Плазма': { buyPrice: 25, sellPrice: 15 }
      };
      
      // Состояние свернутых панелей
      const collapsedState = {
        statusPanel: false,
        logPanel: false,
        inventoryPanel: false,
        upgradesPanel: false,
        tradePanel: false,
        questsPanel: false
      };
      
      // DOM элементы
      const currencyDisplay = document.getElementById('currencyDisplay');
      const timeDisplay = document.getElementById('timeDisplay');
      const defenseDisplay = document.getElementById('defenseDisplay');
      const logBox = document.getElementById('logBox');
      const inventoryDiv = document.getElementById('inventory');
      const aiStatusText = document.getElementById('aiStatusText');
      const coalStatus = document.getElementById('coalStatus');
      const rebelStatus = document.getElementById('rebelStatus');
      const mineBtn = document.getElementById('mineBtn');
      const miningBonusSpan = document.getElementById('miningBonus');
      const miningLevel = document.getElementById('miningLevel');
      const miningProgress = document.getElementById('miningProgress');
      const upgradeMiningBtn = document.getElementById('upgradeMiningBtn');
      const defenseStatus = document.getElementById('defenseStatus');
      const upgradeDefenseBtn = document.getElementById('upgradeDefenseBtn');
      const defenseLevel = document.getElementById('defenseLevel');
      const upgradeDefenseLevelBtn = document.getElementById('upgradeDefenseLevelBtn');
      const miningChipsReq = document.getElementById('miningChipsReq');
      const defensePlasmaReq = document.getElementById('defensePlasmaReq');
      const defenseChipsReq = document.getElementById('defenseChipsReq');
      const defensePlasmaLevelReq = document.getElementById('defensePlasmaLevelReq');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const autoScrollBtn = document.getElementById('autoScrollBtn');
      const questsContainer = document.getElementById('questsContainer');
      const buyItemsContainer = document.getElementById('buyItemsContainer');
      const sellItemsContainer = document.getElementById('sellItemsContainer');
      const buyModeBtn = document.getElementById('buyModeBtn');
      const sellModeBtn = document.getElementById('sellModeBtn');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const collapseButtons = document.querySelectorAll('.panel-title');

      // Radio Player Elements
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const volumeSlider = document.getElementById('volumeSlider');
      const audioPlayer = new Audio('https://spritelayerradio.com/listen/classic/classic.mp3');
      audioPlayer.loop = true;

      // Вспомогательные функции
      function log(message) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `> ${message}`;
        logBox.appendChild(entry);
        
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
      }
      
      function updateTimeDisplay() {
        const icon = isDay ? '☀️' : '🌙';
        timeDisplay.textContent = `${isDay ? 'День' : 'Ночь'} ${icon} (${Math.ceil(gameTime)}s)`;
      }

      function updateCurrencyDisplay() {
        currencyDisplay.textContent = `${tng}₸`;
      }
      
      function updateDefenseDisplay() {
        const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
        defenseDisplay.textContent = `${defensePower}%`;
      }

      // Система сохранения
      function saveGame() {
        const saveData = {
          inventory,
          tng,
          coalEnabled,
          gameTime,
          isDay,
          passiveCounter,
          trashSold,
          upgrades,
          autoScrollEnabled,
          rebelActivity,
          lastUpdateTime: Date.now(),
          nightsSurvived,
          successfulDefenses,
          coalProduced,
          totalMined,
          aiDisabledUntil,
          nightsWithCoal,
          currentQuestIndex,
          storyQuests,
          collapsedState
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
      }

      function loadGame() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            Object.keys(inventory).forEach(key => {
              if (data.inventory[key] !== undefined) inventory[key] = data.inventory[key];
            });
            tng = data.tng ?? 0;
            coalEnabled = data.coalEnabled ?? false;
            gameTime = data.gameTime ?? CYCLE_DURATION / 2;
            isDay = data.isDay ?? true;
            passiveCounter = data.passiveCounter ?? 0;
            trashSold = data.trashSold ?? 0;
            upgrades.mining = data.upgrades?.mining ?? 0;
            upgrades.defense = data.upgrades?.defense ?? false;
            upgrades.defenseLevel = data.upgrades?.defenseLevel ?? 0;
            autoScrollEnabled = data.autoScrollEnabled ?? true;
            rebelActivity = data.rebelActivity ?? 0;
            lastUpdateTime = data.lastUpdateTime ?? Date.now();
            nightsSurvived = data.nightsSurvived ?? 0;
            successfulDefenses = data.successfulDefenses ?? 0;
            coalProduced = data.coalProduced ?? 0;
            totalMined = data.totalMined ?? 0;
            aiDisabledUntil = data.aiDisabledUntil ?? 0;
            nightsWithCoal = data.nightsWithCoal ?? 0;
            currentQuestIndex = data.currentQuestIndex ?? 0;
            
            if (data.storyQuests) {
              data.storyQuests.forEach((savedQuest, index) => {
                if (storyQuests[index]) {
                  storyQuests[index].completed = savedQuest.completed ?? false;
                }
              });
            }
            
            if (data.collapsedState) {
              Object.assign(collapsedState, data.collapsedState);
            }
          } catch (e) {
            console.error('Ошибка загрузки сохранения', e);
          }
        }
      }

      function calculateTrashPrice() {
        const basePrice = 1;
        const priceDrop = Math.floor(trashSold / 5) * 0.05;
        return Math.max(basePrice - priceDrop, 0.3);
      }

      function showStoryMessage(questId) {
        const messages = {
          intro: "Система оживает! Первые ресурсы добыты. CoreBox начинает восстановление.",
          power_up: "ТЭЦ активирована! Теперь ИИ будет работать и ночью. Но помните - каждую ночь требуется уголь.",
          first_night: "Первая ночь пережита. Датчики фиксируют активность повстанцев в периметре.",
          mining_upgrade: "Система добычи улучшена. Анализ показывает аномалии в плазменных месторождениях.",
          plasma_discovery: "Плазма обнаружена! Это ключ к восстановлению ядра CoreBox.",
          defense_activate: "Защитные турели активированы. Теперь у повстанцев будет меньше шансов.",
          rebel_defense: "Атаки отражены! Повстанцы отступают. Осталось восстановить ядро системы.",
          core_restore: "CoreBox полностью восстановлен! Плазменное ядро запущено. Поздравляем!"
        };
        
        if (messages[questId]) {
          log(`💬 ${messages[questId]}`);
        }
      }
      
      function completeCurrentQuest() {
        if (currentQuestIndex >= storyQuests.length) return;
        
        const quest = storyQuests[currentQuestIndex];
        if (quest && !quest.completed) {
          quest.completed = true;
          tng += quest.reward;
          log(`✅ Задание "${quest.title}" выполнено! +${quest.reward}₸`);
          showStoryMessage(quest.id);
          
          // Переходим к следующему заданию
          currentQuestIndex++;
          saveGame();
          render();
        }
      }
      
      function checkQuestsProgress() {
        if (currentQuestIndex >= storyQuests.length) return;
        
        const quest = storyQuests[currentQuestIndex];
        if (!quest || quest.completed) return;
        
        let isCompleted = false;
        
        switch(quest.type) {
          case 'mine_any':
            isCompleted = totalMined >= quest.target;
            break;
            
          case 'activate_coal':
            isCompleted = coalEnabled;
            break;
            
          case 'survive_night':
            isCompleted = nightsWithCoal >= quest.target;
            break;
            
          case 'upgrade_mining':
            isCompleted = upgrades.mining >= quest.target;
            break;
            
          case 'mine_resource':
            isCompleted = inventory[quest.resource] >= quest.target;
            break;
            
          case 'activate_defense':
            isCompleted = upgrades.defense;
            break;
            
          case 'defend_attacks':
            isCompleted = successfulDefenses >= quest.target;
            break;
        }
        
        if (isCompleted) {
          completeCurrentQuest();
        }
      }

      function render() {
        // Обновляем бонус добычи
        miningBonusSpan.textContent = `+${upgrades.mining}%`;
        miningLevel.textContent = upgrades.mining;
        miningProgress.style.width = `${upgrades.mining * 10}%`;
        
        // Обновляем статусы
        coalStatus.textContent = coalEnabled ? 'Активно' : 'Выкл';
        coalStatus.style.color = coalEnabled ? '#00cc66' : '#ff3333';
        defenseStatus.textContent = upgrades.defense ? 'Активно' : 'Выкл';
        defenseLevel.textContent = `Ур. ${upgrades.defenseLevel}/5`;
        
        // Обновляем статус повстанцев
        let rebelText = 'Низкий';
        let rebelColor = '#00cc66';
        if (rebelActivity > 2) {
          rebelText = 'Высокий';
          rebelColor = '#ff3333';
        } else if (rebelActivity > 0) {
          rebelText = 'Средний';
          rebelColor = '#ffcc00';
        }
        rebelStatus.textContent = rebelText;
        rebelStatus.style.color = rebelColor;
        
        // Обновляем статус ИИ
        const aiActive = (isDay || coalEnabled) && Date.now() > aiDisabledUntil;
        aiStatusText.textContent = aiActive ? 'Активен' : 'Неактивен';
        aiStatusText.style.color = aiActive ? '#00cc66' : '#ff3333';
        
        // Обновляем валюту и защиту
        updateCurrencyDisplay();
        updateDefenseDisplay();
        updateTimeDisplay();
        
        // Обновляем кнопки апгрейдов
        upgradeMiningBtn.disabled = upgrades.mining >= 10 || inventory['Чипы'] < 5;
        upgradeDefenseBtn.disabled = upgrades.defense || inventory['Плазма'] < 3;
        upgradeDefenseLevelBtn.disabled = upgrades.defenseLevel >= 5 || 
          inventory['Чипы'] < (upgrades.defenseLevel + 1) * 10 || 
          inventory['Плазма'] < 1;
        
        // Обновляем требования
        miningChipsReq.textContent = `${inventory['Чипы']}/5`;
        miningChipsReq.className = inventory['Чипы'] >= 5 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defensePlasmaReq.textContent = `${inventory['Плазма']}/3`;
        defensePlasmaReq.className = inventory['Плазма'] >= 3 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defenseChipsReq.textContent = `${inventory['Чипы']}/${(upgrades.defenseLevel + 1) * 10}`;
        defenseChipsReq.className = inventory['Чипы'] >= (upgrades.defenseLevel + 1) * 10 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defensePlasmaLevelReq.textContent = `${inventory['Плазма']}/1`;
        defensePlasmaLevelReq.className = inventory['Плазма'] >= 1 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        // Обновляем кнопку автоскролла
        autoScrollBtn.textContent = autoScrollEnabled ? 'Автоскролл ✓' : 'Автоскролл';
        
        // Очищаем инвентарь
        inventoryDiv.innerHTML = '';

        // Отрисовка инвентаря
        Object.entries(inventory).forEach(([name, count]) => {
          if (name === 'ИИ') return;
          
          const slot = document.createElement('div');
          slot.className = 'slot';
          if (name === 'Плазма') slot.classList.add('plasma');
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'item-name';
          nameDiv.textContent = name;
          
          const countDiv = document.createElement('div');
          countDiv.className = 'item-count';
          countDiv.textContent = `x${count}`;
          
          slot.appendChild(nameDiv);
          slot.appendChild(countDiv);

          // Анимация для критической добычи
          if (criticalMining && (name === 'Уголь' || name === 'Плазма')) {
            slot.classList.add('critical');
            criticalMining = false;
          }
          
          // Бонусы добычи
          if (name === 'Уголь' || name === 'Мусор') {
            const bonusDiv = document.createElement('div');
            bonusDiv.className = 'mining-bonus';
            const baseChance = name === 'Уголь' ? 3 : 1.5;
            const totalBonus = upgrades.mining + (coalEnabled ? (name === 'Уголь' ? 2 : 1) : 0);
            bonusDiv.textContent = `+${baseChance + totalBonus}%`;
            slot.appendChild(bonusDiv);
          }

          // Уголь
          if (name === 'Уголь') {
            if (coalEnabled) {
              slot.style.borderColor = 'var(--primary)';
              slot.style.boxShadow = '0 0 8px var(--primary)';
            }
            
            slot.onclick = () => handleCoalInteraction();
          }
          // Плазма для защиты
          else if (name === 'Плазма' && count > 0) {
            slot.classList.add('defense');
          }

          inventoryDiv.appendChild(slot);
        });

        // Заполнение пустых слотов
        while (inventoryDiv.children.length < maxSlots) {
          const slot = document.createElement('div');
          slot.className = 'slot empty';
          slot.innerHTML = '<div class="item-name">[Пусто]</div><div class="item-count">+</div>';
          inventoryDiv.appendChild(slot);
        }
        
        // Отрисовка заданий
        renderQuests();
        
        // Отрисовка торговли
        renderTrade();
        
        // Применяем состояние свернутости
        applyCollapsedState();
      }
      
      function renderQuests() {
        questsContainer.innerHTML = '';
        
        if (currentQuestIndex >= storyQuests.length) {
          questsContainer.innerHTML = `
            <div class="quest-card">
              <div class="quest-header">
                <div class="quest-title">Миссия выполнена!</div>
              </div>
              <div class="quest-description">
                Вы полностью восстановили работу CoreBox! Система функционирует в штатном режиме.
              </div>
            </div>
          `;
          return;
        }
        
        const quest = storyQuests[currentQuestIndex];
        if (!quest) return;
        
        let progressText = '';
        let progressPercent = 0;
        
        switch(quest.type) {
          case 'mine_any':
            progressText = `Добыто: ${totalMined}/${quest.target}`;
            progressPercent = Math.min(100, (totalMined / quest.target) * 100);
            break;
            
          case 'activate_coal':
            progressText = coalEnabled ? 'ТЭЦ активна' : 'ТЭЦ неактивна';
            progressPercent = coalEnabled ? 100 : 0;
            break;
            
          case 'survive_night':
            progressText = `Ночей: ${nightsWithCoal}/${quest.target}`;
            progressPercent = Math.min(100, (nightsWithCoal / quest.target) * 100);
            break;
            
          case 'upgrade_mining':
            progressText = `Уровень: ${upgrades.mining}/${quest.target}`;
            progressPercent = Math.min(100, (upgrades.mining / quest.target) * 100);
            break;
            
          case 'mine_resource':
            progressText = `${quest.resource}: ${inventory[quest.resource] || 0}/${quest.target}`;
            progressPercent = Math.min(100, ((inventory[quest.resource] || 0) / quest.target) * 100);
            break;
            
          case 'activate_defense':
            progressText = upgrades.defense ? 'Защита активна' : 'Защита неактивна';
            progressPercent = upgrades.defense ? 100 : 0;
            break;
            
          case 'defend_attacks':
            progressText = `Защит: ${successfulDefenses}/${quest.target}`;
            progressPercent = Math.min(100, (successfulDefenses / quest.target) * 100);
            break;
        }
        
        const questCard = document.createElement('div');
        questCard.className = 'quest-card';
        questCard.innerHTML = `
          <div class="quest-header">
            <div class="quest-title">${quest.title}</div>
            <div class="quest-reward">${quest.reward}₸</div>
          </div>
          ${progressPercent > 0 ? `
            <div class="progress-container">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>
          ` : ''}
          <div class="quest-description">
            ${quest.description}<br>
            ${progressText}
          </div>
        `;
        
        questsContainer.appendChild(questCard);
      }
      
      function renderTrade() {
        buyItemsContainer.innerHTML = '';
        sellItemsContainer.innerHTML = '';
        
        // Отрисовка товаров для покупки
        Object.entries(tradeItems).forEach(([itemName, item]) => {
          const buyItemElement = document.createElement('div');
          buyItemElement.className = 'trade-item';
          buyItemElement.innerHTML = `
            <div class="trade-item-name">${itemName}</div>
            <div class="trade-item-price">${item.buyPrice}₸</div>
            <div class="trade-item-amount">В инвентаре: ${inventory[itemName] || 0}</div>
          `;
          
          buyItemElement.addEventListener('click', () => {
            const price = item.buyPrice;
            if (tng >= price) {
              tng -= price;
              inventory[itemName] = (inventory[itemName] || 0) + 1;
              
              log(`Куплен 1 ${itemName} за ${price}₸`);
              updateCurrencyDisplay();
              saveGame();
              render();
              checkQuestsProgress();
            } else {
              log(`Недостаточно средств для покупки ${itemName}`);
            }
          });
          
          buyItemsContainer.appendChild(buyItemElement);
        });
        
        // Отрисовка товаров для продажи
        Object.entries(inventory).forEach(([itemName, count]) => {
          if (itemName === 'ИИ' || count <= 0) return;
          
          const sellItemElement = document.createElement('div');
          sellItemElement.className = 'trade-item';
          
          let price;
          if (itemName === 'Мусор') {
            price = calculateTrashPrice().toFixed(2);
          } else {
            price = tradeItems[itemName]?.sellPrice || 1;
          }
          
          sellItemElement.innerHTML = `
            <div class="trade-item-name">${itemName}</div>
            <div class="trade-item-price">${price}₸</div>
            <div class="trade-item-amount">${count} шт.</div>
          `;
          
          sellItemElement.addEventListener('click', () => {
            if (inventory[itemName] > 0) {
              inventory[itemName]--;
              tng += parseFloat(price);
              if (itemName === 'Мусор') trashSold++;
              
              log(`Продан 1 ${itemName} за ${price}₸`);
              updateCurrencyDisplay();
              saveGame();
              render();
              checkQuestsProgress();
            }
          });
          
          sellItemsContainer.appendChild(sellItemElement);
        });
      }
      
      function applyCollapsedState() {
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
          const title = panel.querySelector('.panel-title span').textContent;
          
          if (title.includes('Состояние') && collapsedState.statusPanel) {
            panel.classList.add('collapsed');
          } else if (title.includes('журнал') && collapsedState.logPanel) {
            panel.classList.add('collapsed');
          } else if (title.includes('Инвентарь') && collapsedState.inventoryPanel) {
            panel.classList.add('collapsed');
          } else if (title.includes('апгрейды') && collapsedState.upgradesPanel) {
            panel.classList.add('collapsed');
          } else if (title.includes('Торговля') && collapsedState.tradePanel) {
            panel.classList.add('collapsed');
          } else if (title.includes('Задания') && collapsedState.questsPanel) {
            panel.classList.add('collapsed');
          }
        });
      }
      
      function handleRebelAttack() {
        const threatLevel = Math.min(1, rebelActivity * 0.2);
        
        if (Math.random() < threatLevel) {
          const attackType = Math.floor(Math.random() * 5);
          let message = "🌙 Повстанцы атаковали!";
          let severeAttack = false;
          
          switch(attackType) {
            case 0: // Кража ресурсов
              const resources = Object.keys(inventory).filter(k => k !== 'ИИ' && inventory[k] > 0);
              if (resources.length > 0) {
                const stolenResource = resources[Math.floor(Math.random() * resources.length)];
                const amount = Math.min(inventory[stolenResource], Math.floor(Math.random() * 3) + 1);
                inventory[stolenResource] -= amount;
                message += ` Украдено ${amount} ${stolenResource}`;
              }
              break;
              
            case 1: // Повреждение оборудования
              if (upgrades.mining > 0 && Math.random() < 0.3) {
                upgrades.mining--;
                message += " Повреждена система добычи! Уровень понижен";
                severeAttack = true;
              }
              break;
              
            case 2: // Вандализм
              if (inventory['Мусор'] > 0) {
                const destroyed = Math.min(inventory['Мусор'], Math.floor(Math.random() * 5) + 3);
                inventory['Мусор'] -= destroyed;
                message += ` Уничтожено ${destroyed} мусора`;
              }
              break;
              
            case 3: // Поломка турелей
              if (upgrades.defense && Math.random() < 0.2) {
                upgrades.defense = false;
                message += " Туррели защиты сломаны!";
                severeAttack = true;
              }
              break;
              
            case 4: // Взлом ИИ (редкий)
              if (Math.random() < 0.1) {
                aiDisabledUntil = Date.now() + 300000; // 5 минут
                message += " Взлом ИИ! Система неактивна 5 минут";
                severeAttack = true;
              }
              break;
          }
          
          log(message);
          
          // Увеличиваем активность повстанцев
          rebelActivity += severeAttack ? 2 : 1;
          
          // Снижаем уровень защиты после серьезных атак
          if (severeAttack && upgrades.defenseLevel > 0 && Math.random() < 0.5) {
            upgrades.defenseLevel--;
            log("⚠️ Уровень защиты понижен из-за атаки повстанцев");
          }
          
          saveGame();
        }
      }

      // Обработчики взаимодействий
      function handleCoalInteraction() {
        if (coalEnabled) {
          coalEnabled = false;
          log('Угольная ТЭЦ отключена');
        } else {
          if (inventory['Уголь'] > 0) {
            inventory['Уголь']--;
            coalEnabled = true;
            log('Угольная ТЭЦ активирована (-1 уголь)');
            
            // Проверка задания на активацию ТЭЦ
            if (currentQuestIndex < storyQuests.length && 
                storyQuests[currentQuestIndex].type === 'activate_coal') {
              checkQuestsProgress();
            }
          } else {
            log('Нет угля для активации!');
          }
        }
        saveGame();
        render();
      }
      
      function mineResources() {
        const aiActive = (isDay || coalEnabled) && Date.now() > aiDisabledUntil;
        if (!aiActive) {
          log('❌ ИИ неактивен! Нужна энергия');
          return;
        }
        
        let coalChance = 0.02 + (coalEnabled ? 0.02 : 0) + (upgrades.mining * 0.01);
        let trashChance = 0.01 + (coalEnabled ? 0.01 : 0) + (upgrades.mining * 0.01);
        let chipChance = 0.005;
        let plasmaChance = 0.003;
        const isCritical = Math.random() < 0.05;

        let foundSomething = false;

        if (Math.random() < coalChance) {
          const amount = isCritical ? 2 : 1;
          inventory['Уголь'] += amount;
          criticalMining = isCritical;
          
          log(`Найден${amount > 1 ? 'о' : ''} ${amount} угля 🪨${isCritical ? ' ✨' : ''}`);
          foundSomething = true;
          totalMined += amount;
        }
        
        if (Math.random() < trashChance) {
          inventory['Мусор']++;
          log('Найден мусор ♻️');
          foundSomething = true;
          totalMined++;
        }
        
        if (Math.random() < chipChance) {
          inventory['Чипы']++;
          criticalMining = true;
          log('Найден чип 🎛️✨');
          foundSomething = true;
          totalMined++;
        }
        
        if (Math.random() < plasmaChance) {
          inventory['Плазма']++;
          criticalMining = true;
          log('Найдена плазма ⚡✨');
          foundSomething = true;
          totalMined++;
        }
        
        // Проверка заданий на добычу
        if (foundSomething && currentQuestIndex < storyQuests.length) {
          checkQuestsProgress();
        }
        
        saveGame();
        render();
      }
      
      function upgradeMining() {
        if (upgrades.mining < 10 && inventory['Чипы'] >= 5) {
          inventory['Чипы'] -= 5;
          upgrades.mining++;
          
          log(`Улучшена добыча! Теперь +${upgrades.mining}% к шансам`);
          
          // Проверка задания на апгрейд
          if (currentQuestIndex < storyQuests.length && 
              storyQuests[currentQuestIndex].type === 'upgrade_mining') {
            checkQuestsProgress();
          }
          
          saveGame();
          render();
        }
      }
      
      function activateDefense() {
        if (!upgrades.defense && inventory['Плазма'] >= 3) {
          inventory['Плазма'] -= 3;
          upgrades.defense = true;
          
          log('Активированы туррели защиты! (-3 плазмы)');
          
          // Проверка задания на активацию защиты
          if (currentQuestIndex < storyQuests.length && 
              storyQuests[currentQuestIndex].type === 'activate_defense') {
            checkQuestsProgress();
          }
          
          saveGame();
          render();
        }
      }
      
      function upgradeDefense() {
        if (upgrades.defenseLevel < 5 && 
            inventory['Чипы'] >= (upgrades.defenseLevel + 1) * 10 && 
            inventory['Плазма'] >= 1) {
          const chipsCost = (upgrades.defenseLevel + 1) * 10;
          inventory['Чипы'] -= chipsCost;
          inventory['Плазма'] -= 1;
          upgrades.defenseLevel++;
          
          log(`Улучшена защита до уровня ${upgrades.defenseLevel}! (-${chipsCost} чипов и -1 плазмы)`);
          saveGame();
          render();
        }
      }
      
      function clearLog() {
        logBox.innerHTML = '';
        log('Журнал очищен');
      }
      
      function toggleAutoScroll() {
        autoScrollEnabled = !autoScrollEnabled;
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
        saveGame();
        render();
      }
      
      function toggleCollapse(panel) {
        const title = panel.querySelector('.panel-title span').textContent;
        
        if (title.includes('Состояние')) {
          collapsedState.statusPanel = !collapsedState.statusPanel;
        } else if (title.includes('журнал')) {
          collapsedState.logPanel = !collapsedState.logPanel;
        } else if (title.includes('Инвентарь')) {
          collapsedState.inventoryPanel = !collapsedState.inventoryPanel;
        } else if (title.includes('апгрейды')) {
          collapsedState.upgradesPanel = !collapsedState.upgradesPanel;
        } else if (title.includes('Торговля')) {
          collapsedState.tradePanel = !collapsedState.tradePanel;
        } else if (title.includes('Задания')) {
          collapsedState.questsPanel = !collapsedState.questsPanel;
        }
        
        panel.classList.toggle('collapsed');
        saveGame();
      }
      
      function switchTab(tabName) {
        tabContents.forEach(content => {
          content.classList.remove('active');
        });
        
        tabs.forEach(tab => {
          tab.classList.remove('active');
        });
        
        document.getElementById(`${tabName}-tab`).classList.add('active');
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
      }
      
      function toggleBuySellMode(isBuyMode) {
        buyModeBtn.classList.toggle('active', isBuyMode);
        sellModeBtn.classList.toggle('active', !isBuyMode);
        buyItemsContainer.style.display = isBuyMode ? 'grid' : 'none';
        sellItemsContainer.style.display = isBuyMode ? 'none' : 'grid';
      }

      function setupRadioPlayer() {
        playBtn.addEventListener('click', () => {
          audioPlayer.play();
          log('Радио включено');
        });
        
        pauseBtn.addEventListener('click', () => {
          audioPlayer.pause();
          log('Радио выключено');
        });
        
        volumeSlider.addEventListener('input', (e) => {
          audioPlayer.volume = e.target.value;
        });
        
        audioPlayer.volume = volumeSlider.value;
      }

      // Игровой цикл
      function gameLoop() {
        const now = Date.now();
        const secondsPassed = Math.floor((now - lastUpdateTime) / 1000);
        lastUpdateTime = now;
        
        gameTime -= secondsPassed;
        
        while (gameTime <= 0) {
          gameTime += CYCLE_DURATION;
          const wasNight = !isDay;
          isDay = !isDay;
          
          if (wasNight) {
            nightsSurvived++;
            
            if (coalEnabled) {
              nightsWithCoal++;
              
              if (inventory['Уголь'] > 0) {
                inventory['Уголь']--;
                log('🌙 Ночь - сгорел 1 уголь');
              } else {
                coalEnabled = false;
                log('🌙 Ночь - уголь закончился, ТЭЦ отключена');
              }
            }
            
            // Атака повстанцев
            const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
            if (Math.random() * 100 > defensePower) {
              handleRebelAttack();
            } else if (upgrades.defense) {
              log('🌙 Система защиты отразила атаку повстанцев');
              successfulDefenses++;
            }
            
            // Увеличиваем активность повстанцев ночью
            if (Math.random() < 0.3) {
              rebelActivity++;
            }
            
            // Проверка заданий, связанных с ночью
            checkQuestsProgress();
          } else {
            // День - снижаем активность повстанцев
            rebelActivity = Math.max(0, rebelActivity - 1);
          }
          
          log(isDay ? '☀️ Наступил день' : '🌙 Наступила ночь');
          saveGame();
        }

        // Пассивный доход
        passiveCounter += secondsPassed;
        while (passiveCounter >= 10) {
          passiveCounter -= 10;
          const aiActive = (isDay || coalEnabled) && Date.now() > aiDisabledUntil;
          if (aiActive) {
            const coalChance = 0.003 + (upgrades.mining * 0.001);
            const trashChance = 0.007 + (upgrades.mining * 0.001);
            const chipChance = 0.001;
            const plasmaChance = 0.0005;
            
            if (Math.random() < coalChance) {
              inventory['Уголь']++;
              totalMined++;
            }
            if (Math.random() < trashChance) {
              inventory['Мусор']++;
              totalMined++;
            }
            if (Math.random() < chipChance) {
              inventory['Чипы']++;
              totalMined++;
            }
            if (Math.random() < plasmaChance) {
              inventory['Плазма']++;
              totalMined++;
            }
            
            saveGame();
            checkQuestsProgress();
          }
        }

        render();
      }

      // Инициализация игры
      function initEventListeners() {
        mineBtn.addEventListener('click', mineResources);
        upgradeMiningBtn.addEventListener('click', upgradeMining);
        upgradeDefenseBtn.addEventListener('click', activateDefense);
        upgradeDefenseLevelBtn.addEventListener('click', upgradeDefense);
        clearLogBtn.addEventListener('click', clearLog);
        autoScrollBtn.addEventListener('click', toggleAutoScroll);
        buyModeBtn.addEventListener('click', () => toggleBuySellMode(true));
        sellModeBtn.addEventListener('click', () => toggleBuySellMode(false));
        
        document.querySelectorAll('.panel-title').forEach(title => {
          title.addEventListener('click', (e) => {
            if (e.target.classList.contains('collapse-icon')) return;
            toggleCollapse(title.closest('.panel'));
          });
        });
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            switchTab(tab.dataset.tab);
          });
        });
      }

      function initGame() {
        loadGame();
        initEventListeners();
        setupRadioPlayer();
        
        render();
        toggleBuySellMode(true);
        
        setInterval(gameLoop, 1000);
        
        log('Система CoreBox 2.9 инициализирована');
        log('Добро пожаловать в систему добычи ресурсов!');
        log('Ваша задача - восстановить работу комплекса и защитить его от повстанцев');
      }

      initGame();
    });
  </script>
</body>
</html>
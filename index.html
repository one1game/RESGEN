<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreBox 3.0 - Rust</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
<!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="authOverlay" class="auth-overlay">
    <div class="auth-container">
        <div class="auth-header">
            <h2>CoreBox 3.0</h2>
            <p>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</p>
        </div>
        
        <form id="authForm" class="auth-form">
            <div class="input-group">
                <label for="username">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="username" name="username" required minlength="3" maxlength="20" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞">
            </div>
            
            <div class="input-group">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" name="password" required minlength="4" placeholder="–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞">
            </div>
            
            <div class="auth-buttons">
                <button type="submit" id="loginBtn" class="auth-btn primary">–í–æ–π—Ç–∏</button>
                <button type="button" id="registerBtn" class="auth-btn secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
        </form>
        
        <div id="authMessage" class="auth-message"></div>
        
        <div class="auth-info">
            <p>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
            
            <!-- –°–°–´–õ–ö–ò –ù–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–¢–†–ê–ù–ò–¶–´ (–ë–ï–ó target="_blank") -->
            <div class="additional-links">
                <a href="faq.html" class="story-link">
                    üìñ FAQ
                </a>
                <a href="history.html" class="story-link history-link">
                    üé≠ –ò–°–¢–û–†–ò–Ø –ú–ò–†–ê
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –ò–ì–†–´ (–°–ö–†–´–¢ –î–û –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò) -->
<div id="gameContent" style="display: none;">
    <div class="header">
        <h1>CoreBox 3.0</h1>
        
        <div class="user-info" id="userInfo">
            <span id="usernameDisplay"></span>
            <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div>–¶–ò–ö–õ</div>
                <div id="timeDisplay" class="stat-value">–î–ï–ù–¨ 08:00</div>
            </div>
        </div>
    </div>

    <div class="main">
        <!-- –°–ï–†–¨–ï–ó–ù–ê–Ø –°–ï–ö–¶–ò–Ø –°–û–°–¢–û–Ø–ù–ò–Ø –°–ò–°–¢–ï–ú–´ -->
        <div class="panel">
            <div class="panel-title">
                <span>–°–ò–°–¢–ï–ú–ù–´–ô –°–¢–ê–¢–£–°</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="panel-content">
                <div class="system-status">
                    <div class="status-line">
                        <div class="status-label">–¢–≠–¶:</div>
                        <div class="status-value" id="coalStatus">–û–§–§–õ–ê–ô–ù</div>
                        <div class="status-indicator offline"></div>
                    </div>
                    <div class="status-line">
                        <div class="status-label">–ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢:</div>
                        <div class="status-value" id="aiStatusText">–ù–ï–ê–ö–¢–ò–í–ï–ù</div>
                        <div class="status-indicator offline"></div>
                    </div>
                    <!-- –î–û–ë–ê–í–õ–ï–ù–ê –ó–ê–©–ò–¢–ê -->
                    <div class="status-line">
                        <div class="status-label">–°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´:</div>
                        <div class="status-value" id="defenseStatusText">–ù–ï–ê–ö–¢–ò–í–ù–ê</div>
                        <div class="status-indicator offline"></div>
                    </div>
                    <div class="status-line">
                        <div class="status-label">–£–ì–†–û–ó–ê –ü–û–í–°–¢–ê–ù–¶–ï–í:</div>
                        <div class="status-value" id="rebelStatus">–ù–ò–ó–ö–ò–ô –£–†–û–í–ï–ù–¨</div>
                        <div class="threat-level low"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mining-action">
            <button id="mineBtn" class="btn pulse">–ò–ù–ò–¶–ò–ò–†–û–í–ê–¢–¨ –î–û–ë–´–ß–£ <span id="miningBonus">+0%</span></button>
            
            <!-- –°–ò–°–¢–ï–ú–ê –ö–õ–ò–ö–û–í -->
            <div class="click-system">
                <!-- –ú–æ—â–Ω–æ—Å—Ç—å -->
                <div class="power-section">
                    <div class="power-label">
                        <span>–í–´–ß–ò–°–õ–ò–¢–ï–õ–¨–ù–ê–Ø –ú–û–©–ù–û–°–¢–¨:</span>
                        <span id="powerText">0/100</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="powerFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–ª–∏–∫–æ–≤ -->
                <div class="click-progress-section">
                    <div class="click-label">
                        <span>–ü–†–û–ì–†–ï–°–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò:</span>
                        <span id="clickProgressText">0/10</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill click-progress" id="clickProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–∫–ª–∏–∫–æ–≤ -->
                <div class="auto-click-section">
                    <div class="auto-click-status">
                        <span>–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –î–û–ë–´–ß–ê:</span>
                        <span id="autoClickStatus">–û–¢–ö–õ–Æ–ß–ï–ù–ê</span>
                    </div>
                    <div class="auto-click-settings">
                        <span class="setting-icon">‚ö°</span>
                        <span class="setting-label">–ú–û–©–ù–û–°–¢–¨/–¶–ò–ö–õ:</span>
                        <span id="powerPerClick" class="setting-value">1</span>
                        
                        <span class="setting-separator">|</span>
                        
                        <span class="setting-icon">‚è±Ô∏è</span>
                        <span class="setting-label">–ò–ù–¢–ï–†–í–ê–õ:</span>
                        <span id="autoClickInterval" class="setting-value">5</span>
                        <span class="setting-unit">–°–ï–ö</span>
                        
                        <span class="setting-separator">|</span>
                        
                        <span class="setting-icon">üíé</span>
                        <span class="setting-label">–°–¢–û–ò–ú–û–°–¢–¨:</span>
                        <span id="autoClickCost" class="setting-value">1</span>
                        <span class="setting-unit">–ú–û–©–ù</span>
                    </div>
                    <div class="auto-click-info">
                        –£–î–ï–†–ñ–ò–í–ê–ô–¢–ï –î–õ–Ø –ê–ö–¢–ò–í–ê–¶–ò–ò –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –î–û–ë–´–ß–ò
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">
                <span>–°–ò–°–¢–ï–ú–ù–´–ô –ñ–£–†–ù–ê–õ</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="panel-content">
                <div class="log-controls">
                    <button id="clearLogBtn" class="log-btn">–û–ß–ò–°–¢–ò–¢–¨</button>
                    <button id="autoScrollBtn" class="log-btn">–ê–í–¢–û–°–ö–†–û–õ–õ</button>
                </div>
                <div id="logBox" style="height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="inventory">–ò–ù–í–ï–ù–¢–ê–†–¨</div>
            <div class="tab" data-tab="upgrades">–ú–û–î–£–õ–ò</div>
            <div class="tab" data-tab="trade">–¢–û–†–ì–û–í–õ–Ø</div>
            <div class="tab" data-tab="quests">–ó–ê–î–ê–ù–ò–Ø</div>
        </div>
        
        <div class="tab-content active" id="inventory-tab">
            <div class="panel">
                <div class="panel-title">
                    <span>–°–ò–°–¢–ï–ú–ù–´–ï –†–ï–°–£–†–°–´</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="panel-content">
                    <!-- –¢–û–õ–¨–ö–û –û–î–ò–ù –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–°–ï–• –Ø–ß–ï–ô–ö -->
                    <div class="inventory-grid" id="resourcesContainer">
                        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –í–°–ï —è—á–µ–π–∫–∏ –≤–∫–ª—é—á–∞—è —Ç–µ–Ω–≥–µ -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="upgrades-tab">
            <div class="panel">
                <div class="panel-title">
                    <span>–°–ò–°–¢–ï–ú–ù–´–ï –ú–û–î–£–õ–ò</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="upgrade-container">
                        <div class="upgrade-card">
                            <div class="upgrade-header">
                                <div class="upgrade-title">–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –î–û–ë–´–ß–ò</div>
                                <div class="upgrade-level">–£–†. <span id="miningLevel">0</span>/10</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-fill" id="miningProgress" style="width: 0%"></div>
                            </div>
                            
                            <div class="upgrade-requirements">
                                <div class="requirement">
                                    <div class="requirement-name">
                                        <div class="requirement-icon">üéõÔ∏è</div>
                                        <span>–ú–ò–ö–†–û–°–•–ï–ú–´:</span>
                                    </div>
                                    <div class="requirement-value" id="miningChipsReq">0/5</div>
                                </div>
                            </div>
                            
                            <div class="upgrade-cost">
                                <button id="upgradeMiningBtn" class="upgrade-btn">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
                            </div>
                        </div>
                        
                        <div class="upgrade-card">
                            <div class="upgrade-header">
                                <div class="upgrade-title">–°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´</div>
                                <div class="upgrade-level" id="defenseStatus">–ù–ï–ê–ö–¢–ò–í–ù–û</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                            
                            <div class="upgrade-requirements">
                                <div class="requirement">
                                    <div class="requirement-name">
                                        <div class="requirement-icon">‚ö°</div>
                                        <span>–ü–õ–ê–ó–ú–ê:</span>
                                    </div>
                                    <div class="requirement-value" id="defensePlasmaReq">0/3</div>
                                </div>
                            </div>
                            
                            <div class="upgrade-cost">
                                <button id="upgradeDefenseBtn" class="upgrade-btn">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
                            </div>
                        </div>
                        
                        <div class="upgrade-card">
                            <div class="upgrade-header">
                                <div class="upgrade-title">–£–°–ò–õ–ï–ù–ò–ï –ó–ê–©–ò–¢–´</div>
                                <div class="upgrade-level" id="defenseLevel">–£–†. 0/5</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                            
                            <div class="upgrade-requirements">
                                <div class="requirement">
                                    <div class="requirement-name">
                                        <div class="requirement-icon">üéõÔ∏è</div>
                                        <span>–ú–ò–ö–†–û–°–•–ï–ú–´:</span>
                                    </div>
                                    <div class="requirement-value" id="defenseChipsReq">0/10</div>
                                </div>
                                <div class="requirement">
                                    <div class="requirement-name">
                                        <div class="requirement-icon">‚ö°</div>
                                        <span>–ü–õ–ê–ó–ú–ê:</span>
                                    </div>
                                    <div class="requirement-value" id="defensePlasmaLevelReq">0/1</div>
                                </div>
                            </div>
                            
                            <div class="upgrade-cost">
                                <button id="upgradeDefenseLevelBtn" class="upgrade-btn">–£–°–ò–õ–ò–¢–¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="trade-tab">
            <div class="panel">
                <div class="panel-title">
                    <span>–¢–û–†–ì–û–í–´–ô –¢–ï–†–ú–ò–ù–ê–õ</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="trade-container">
                        <div class="trade-mode-toggle">
                            <button id="buyModeBtn" class="trade-mode-btn active">–ó–ê–ö–£–ü–ö–ê</button>
                            <button id="sellModeBtn" class="trade-mode-btn">–ü–†–û–î–ê–ñ–ê</button>
                        </div>
                        
                        <div id="buyItemsContainer" class="trade-items-grid">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ Rust -->
                        </div>
                        
                        <div id="sellItemsContainer" class="trade-items-grid" style="display: none;">
                            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ Rust -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="quests-tab">
            <div class="panel">
                <div class="panel-title">
                    <span>–°–ò–°–¢–ï–ú–ù–´–ï –ó–ê–î–ê–ß–ò</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="quest-container" id="questsContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±—ã—á–∏ -->
    <div id="floatingMineBtn" class="floating-mine-btn">
        <span class="btn-icon">‚öôÔ∏è</span>
        <span class="btn-text">–î–û–ë–´–ß–ê</span>
        <span id="miningBonusFloat" class="mining-bonus">+0%</span>
    </div>
</div>

<script type="module">
  import init, { start_game, apply_config_from_admin } from './pkg/corebox_rs.js';

  let game;
  let lastConfigHash = null;
  let isAutoClicking = false;
  let currentUser = null;

  // –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const USER_STORAGE_KEY = 'corebox_users';
  const CURRENT_USER_KEY = 'corebox_current_user';

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  function getUsers() {
      const usersJson = localStorage.getItem(USER_STORAGE_KEY);
      return usersJson ? JSON.parse(usersJson) : {};
  }

  function saveUsers(users) {
      localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
  }

  function getCurrentUser() {
      const userJson = localStorage.getItem(CURRENT_USER_KEY);
      return userJson ? JSON.parse(userJson) : null;
  }

  function setCurrentUser(user) {
      if (user) {
          localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
      } else {
          localStorage.removeItem(CURRENT_USER_KEY);
      }
      currentUser = user;
  }

  // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  function showAuthMessage(message, isError = false) {
      const messageEl = document.getElementById('authMessage');
      messageEl.textContent = message;
      messageEl.className = `auth-message ${isError ? 'error' : 'success'}`;
  }

  function loginUser(username, password) {
      const users = getUsers();
      
      if (users[username]) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (users[username].password === password) {
              // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
              users[username].lastLogin = new Date().toISOString();
              saveUsers(users);
              
              setCurrentUser({ username, ...users[username] });
              showAuthMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
              setTimeout(() => {
                  document.getElementById('authOverlay').style.display = 'none';
                  document.getElementById('gameContent').style.display = 'block';
                  showUserInfo();
                  initializeGame();
              }, 1000);
              
              return true;
          } else {
              showAuthMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', true);
              return false;
          }
      } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          users[username] = {
              password: password,
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString()
          };
          
          saveUsers(users);
          setCurrentUser({ username, ...users[username] });
          showAuthMessage(`–ê–∫–∫–∞—É–Ω—Ç ${username} —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!`);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
          setTimeout(() => {
              document.getElementById('authOverlay').style.display = 'none';
              document.getElementById('gameContent').style.display = 'block';
              showUserInfo();
              initializeGame();
          }, 1000);
          
          return true;
      }
  }

  function showUserInfo() {
      if (currentUser) {
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('usernameDisplay').textContent = currentUser.username;
          
          document.getElementById('logoutBtn').addEventListener('click', logout);
      }
  }

  function logout() {
      setCurrentUser(null);
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('gameContent').style.display = 'none';
      document.getElementById('authForm').reset();
      document.getElementById('authMessage').textContent = '';
      document.getElementById('userInfo').style.display = 'none';
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
      setTimeout(() => {
          location.reload();
      }, 500);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  function initializeAuth() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const user = getCurrentUser();
      if (user) {
          document.getElementById('authOverlay').style.display = 'none';
          document.getElementById('gameContent').style.display = 'block';
          currentUser = user;
          showUserInfo();
          initializeGame();
          return;
      }
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º—ã
      const authForm = document.getElementById('authForm');
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      
      authForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;
          
          if (username.length < 3) {
              showAuthMessage('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!', true);
              return;
          }
          
          if (password.length < 4) {
              showAuthMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤!', true);
              return;
          }
          
          loginUser(username, password);
      });
      
      registerBtn.addEventListener('click', () => {
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;
          
          if (username.length < 3) {
              showAuthMessage('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!', true);
              return;
          }
          
          if (password.length < 4) {
              showAuthMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤!', true);
              return;
          }
          
          const users = getUsers();
          if (users[username]) {
              showAuthMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', true);
              return;
          }
          
          loginUser(username, password);
      });
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ (—á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
  function hashConfig(configStr) {
      let hash = 0, i, chr;
      if (configStr.length === 0) return hash;
      for (i = 0; i < configStr.length; i++) {
          chr   = configStr.charCodeAt(i);
          hash  = ((hash << 5) - hash) + chr;
          hash |= 0; // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ 32-–±–∏—Ç–Ω–æ–º—É —á–∏—Å–ª—É
      }
      return hash;
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  async function loadConfig() {
      try {
          const resp = await fetch("config.json?_" + Date.now());
          const configStr = await resp.text();
          const currentHash = hashConfig(configStr);

          if (currentHash !== lastConfigHash) {
              lastConfigHash = currentHash;
              
              try {
                  // –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
                  const result = apply_config_from_admin(configStr);
                  console.log("‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω–µ–Ω:", result);
              } catch (e) {
                  // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –æ—á–∏—â–∞–µ–º localStorage
                  console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞, –æ—á–∏—â–∞—é –∫—ç—à:", e);
                  localStorage.removeItem('corebox_config');
                  location.reload();
                  return;
              }
              
              if (game) {
                  game.reload_config();
              }
          }
      } catch (e) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å config.json:", e);
      }
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∫–ª–∏–∫–æ–≤
  function toggleAutoClicking() {
      if (isAutoClicking) {
          // –í—ã–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∫–ª–∏–∫–∏
          game.stop_auto_clicking();
          isAutoClicking = false;
          document.getElementById('mineBtn').classList.remove('auto-clicking');
          document.getElementById('floatingMineBtn').classList.remove('auto-clicking');
      } else {
          // –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∫–ª–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –º–æ—â–Ω–æ—Å—Ç—å
          if (game.get_computational_power() > 0) {
              game.start_auto_clicking();
              isAutoClicking = true;
              document.getElementById('mineBtn').classList.add('auto-clicking');
              document.getElementById('floatingMineBtn').classList.add('auto-clicking');
          }
      }
  }

  function handleClick() {
      // –í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ–º —Ä—É—á–Ω–æ–π –∫–ª–∏–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
      game.add_manual_click();
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
  function setupLongPressHandlers() {
      const mineBtn = document.getElementById('mineBtn');
      const floatingMineBtn = document.getElementById('floatingMineBtn');
      let pressTimer;

      function startPressTimer(element) {
          pressTimer = setTimeout(() => {
              toggleAutoClicking();
          }, 500); // 500ms –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
      }

      function clearPressTimer() {
          if (pressTimer) {
              clearTimeout(pressTimer);
              pressTimer = null;
          }
      }

      // –ú—ã—à–∏–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
      mineBtn.addEventListener('mousedown', () => startPressTimer(mineBtn));
      mineBtn.addEventListener('mouseup', clearPressTimer);
      mineBtn.addEventListener('mouseleave', clearPressTimer);

      // –ú—ã—à–∏–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–ª–∞–≤–∞—é—â–µ–π –∫–Ω–æ–ø–∫–∏
      floatingMineBtn.addEventListener('mousedown', () => startPressTimer(floatingMineBtn));
      floatingMineBtn.addEventListener('mouseup', clearPressTimer);
      floatingMineBtn.addEventListener('mouseleave', clearPressTimer);

      // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
      mineBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          startPressTimer(mineBtn);
      });
      mineBtn.addEventListener('touchend', clearPressTimer);
      mineBtn.addEventListener('touchcancel', clearPressTimer);

      // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–ª–∞–≤–∞—é—â–µ–π –∫–Ω–æ–ø–∫–∏
      floatingMineBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          startPressTimer(floatingMineBtn);
      });
      floatingMineBtn.addEventListener('touchend', clearPressTimer);
      floatingMineBtn.addEventListener('touchcancel', clearPressTimer);
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  function setupEventListeners() {
      // –û–±—ã—á–Ω—ã–µ –∫–ª–∏–∫–∏ - —Ç–æ–ª—å–∫–æ –¥–æ–±—ã—á–∞
      document.getElementById('mineBtn').addEventListener('click', handleClick);
      document.getElementById('floatingMineBtn').addEventListener('click', handleClick);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
      setupLongPressHandlers();

      // –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
      document.addEventListener('click', (event) => {
          if (!game) return;
          const target = event.target.closest('[data-action]');
          if (!target) return;

          const action = target.getAttribute('data-action');
          const resource = target.getAttribute('data-resource');

          if (action === 'buy' && resource) game.buy_resource(resource);
          else if (action === 'sell' && resource) game.sell_resource(resource);
          else if (action === 'toggle-coal') game.toggle_coal();
      });

      // –ê–ø–≥—Ä–µ–π–¥—ã
      document.getElementById('upgradeMiningBtn').addEventListener('click', () => game.upgrade_mining());
      document.getElementById('upgradeDefenseBtn').addEventListener('click', () => game.activate_defense());
      document.getElementById('upgradeDefenseLevelBtn').addEventListener('click', () => game.upgrade_defense());

      // –¢–æ—Ä–≥–æ–≤–ª—è
      document.getElementById('buyModeBtn').addEventListener('click', () => {
          document.getElementById('buyItemsContainer').style.display = 'grid';
          document.getElementById('sellItemsContainer').style.display = 'none';
          document.getElementById('buyModeBtn').classList.add('active');
          document.getElementById('sellModeBtn').classList.remove('active');
      });
      document.getElementById('sellModeBtn').addEventListener('click', () => {
          document.getElementById('buyItemsContainer').style.display = 'none';
          document.getElementById('sellItemsContainer').style.display = 'grid';
          document.getElementById('buyModeBtn').classList.remove('active');
          document.getElementById('sellModeBtn').classList.add('active');
      });

      // –ñ—É—Ä–Ω–∞–ª
      document.getElementById('clearLogBtn').addEventListener('click', () => {
          document.getElementById('logBox').innerHTML = '';
      });
      document.getElementById('autoScrollBtn').addEventListener('click', () => {
          const logBox = document.getElementById('logBox');
          logBox.scrollTop = logBox.scrollHeight;
      });

      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => game.switch_tab(tab.dataset.tab));
      });
  }

  // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã
  async function initializeGame() {
      try {
          // 1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º WASM
          await init();

          // 2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –∏–≥—Ä—ã
          await loadConfig();

          // 3Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
          game = start_game();
          window.game = game; // –¥–ª—è –¥–µ–±–∞–≥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

          // 4Ô∏è‚É£ –°—Ç–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          setupEventListeners();

          // 5Ô∏è‚É£ –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
          setInterval(() => game.game_loop(), 1000);

          // 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
          setInterval(loadConfig, 10000);

          console.log("üéÆ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!");
      } catch (error) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã:", error);
      }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAuth);
  } else {
      initializeAuth();
  }
</script>
</body>
</html>
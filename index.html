<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoreBox 2.8</title>
  <style>
    :root {
      --primary: #00cc99;
      --secondary: #00aaff;
      --accent: #ff3366;
      --dark: #0a1929;
      --darker: #071220;
      --light: #e6f7ff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: radial-gradient(circle at center, #071220, #0a0e1a);
      color: var(--light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
      overflow-x: hidden;
      font-size: 13px;
    }
    
    .cyber-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 170, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 170, 255, 0.05) 1px, transparent 1px);
      background-size: 30px 30px;
      z-index: -1;
      pointer-events: none;
    }
    
    .header {
      text-align: center;
      margin-bottom: 10px;
      width: 100%;
      max-width: 600px;
    }
    
    h1 {
      font-size: 1.8rem;
      margin: 0 0 5px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
      justify-content: center;
    }
    
    .stat-card {
      background: rgba(0, 30, 60, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      min-width: 90px;
      text-align: center;
      font-size: 12px;
    }
    
    .stat-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
      margin-top: 3px;
    }
    
    .main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      width: 100%;
    }
    
    .panel {
      background: rgba(10, 25, 41, 0.9);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      display: flex;
      flex-direction: column;
    }
    
    .panel-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: var(--secondary);
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--primary);
    }
    
    .inventory {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .slot {
      background: linear-gradient(145deg, #132a42, #0e2035);
      border: 1px solid rgba(0, 170, 255, 0.4);
      height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      user-select: none;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .slot:hover {
      transform: translateY(-2px);
      border-color: var(--secondary);
    }
    
    .slot.sell-mode {
      border-color: var(--accent) !important;
      color: var(--accent);
    }
    
    .slot.recycle-mode {
      border-color: var(--primary) !important;
      color: var(--primary);
    }
    
    .slot.critical {
      animation: glow 0.8s;
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 3px #fff; }
      50% { box-shadow: 0 0 12px gold; }
      100% { box-shadow: 0 0 3px #fff; }
    }
    
    .item-name {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
      padding: 0 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    .item-count {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 8px 0;
    }
    
    .btn {
      padding: 8px 12px;
      background: linear-gradient(145deg, var(--primary), #00b386);
      border: none;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
      font-size: 12px;
      min-width: 120px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 204, 153, 0.4);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-secondary {
      background: linear-gradient(145deg, #4a6fa5, #3a5a8a);
      color: white;
    }
    
    #logBox {
      background: rgba(7, 18, 32, 0.9);
      height: 100px;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid rgba(0, 170, 255, 0.3);
      margin-top: 10px;
      position: relative;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
      line-height: 1.3;
    }
    
    .log-controls {
      position: absolute;
      top: 5px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    
    .log-btn {
      background: rgba(0, 170, 255, 0.3);
      border: 1px solid var(--secondary);
      color: var(--light);
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 10px;
    }
    
    .upgrade {
      background: linear-gradient(145deg, #2a1a5f, #1f0f45);
      border-color: #9900ff;
    }
    
    .defense {
      background: linear-gradient(145deg, #5a1a1a, #3a0f0f);
      border-color: #ff3333;
    }
    
    .mining-bonus {
      position: absolute;
      top: 3px;
      right: 3px;
      background: rgba(0, 0, 0, 0.7);
      font-size: 9px;
      color: var(--primary);
      padding: 2px 5px;
      border-radius: 6px;
    }
    
    .upgrade-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    
    .upgrade-card {
      background: linear-gradient(145deg, #1a2a42, #0e1a30);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 170, 255, 0.4);
    }
    
    .upgrade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .upgrade-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .upgrade-level {
      background: rgba(0, 170, 255, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .progress-container {
      width: 100%;
      height: 6px;
      background: #333;
      margin: 8px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 3px;
    }
    
    .upgrade-cost {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    
    .upgrade-btn {
      background: linear-gradient(145deg, var(--primary), #00b386);
      border: none;
      color: #000;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
      min-width: 90px;
      font-size: 11px;
    }
    
    .upgrade-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .upgrade-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0, 204, 153, 0.3);
    }
    
    .ai-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: 12px;
    }
    
    .ai-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #00cc66;
      box-shadow: 0 0 6px #00cc66;
    }
    
    .ai-indicator.inactive {
      background-color: #ff3333;
      box-shadow: 0 0 6px #ff3333;
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      70% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    .upgrade-requirements {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 8px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      font-size: 11px;
    }
    
    .requirement {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .requirement-name {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .requirement-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      background: var(--dark);
      border: 1px solid var(--secondary);
    }
    
    .requirement-value {
      font-weight: bold;
    }
    
    .requirement-met {
      color: var(--primary);
    }
    
    .requirement-not-met {
      color: var(--accent);
    }
    
    .status-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .status-item {
      flex: 1;
      background: rgba(0, 30, 60, 0.6);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
    }
    
    .status-value {
      font-weight: bold;
      color: var(--primary);
      font-size: 1rem;
      margin-top: 3px;
    }
    
    .quest-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    
    .quest-card {
      background: linear-gradient(145deg, #2a1a5f, #1f0f45);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(0, 170, 255, 0.4);
    }
    
    .quest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .quest-title {
      font-weight: 700;
      color: var(--secondary);
      font-size: 12px;
    }
    
    .quest-reward {
      background: rgba(0, 170, 255, 0.3);
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 12px;
      color: gold;
    }
    
    .quest-progress-container {
      width: 100%;
      height: 6px;
      background: #333;
      margin: 8px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .quest-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #ff6699);
      border-radius: 3px;
    }
    
    .quest-description {
      font-size: 11px;
      margin-top: 6px;
      line-height: 1.3;
    }
    
    .mining-action {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    @media (max-width: 600px) {
      .inventory {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .btn {
        min-width: 100%;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      .action-buttons > div {
        flex-direction: column;
        width: 100%;
      }
      
      .action-buttons > div > button {
        width: 100%;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .status-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .log-controls {
        position: static;
        justify-content: center;
        margin-bottom: 5px;
      }
      
      .upgrade-btn {
        min-width: 100%;
        padding: 5px;
      }
      
      .upgrade-container {
        grid-template-columns: 1fr;
      }
      
      .stat-card {
        min-width: 80px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="cyber-grid"></div>

  <div class="header">
    <h1>CoreBox 2.8</h1>
    
    <div class="stats-container">
      <div class="stat-card">
        <div>Баланс</div>
        <div id="currencyDisplay" class="stat-value">0₸</div>
      </div>
      <div class="stat-card">
        <div>Время</div>
        <div id="timeDisplay" class="stat-value">День</div>
      </div>
      <div class="stat-card">
        <div>Защита</div>
        <div id="defenseDisplay" class="stat-value">0%</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-title">Состояние системы</div>
      
      <div class="status-row">
        <div class="status-item">
          <div>ИИ</div>
          <div id="aiStatusText" class="status-value">Активен</div>
        </div>
        <div class="status-item">
          <div>ТЭЦ</div>
          <div id="coalStatus" class="status-value">Выкл</div>
        </div>
        <div class="status-item">
          <div>Повстанцы</div>
          <div id="rebelStatus" class="status-value">Низкий</div>
        </div>
      </div>
    </div>
    
    <!-- Кнопка добычи ресурсов перемещена сюда -->
    <div class="mining-action">
      <button id="mineBtn" class="btn pulse">Добыть ресурсы <span id="miningBonus">+0%</span></button>
    </div>
    
    <div class="panel">
      <div class="panel-title">Системный журнал</div>
      <div id="logBox">
        <div class="log-controls">
          <button id="clearLogBtn" class="log-btn">Очистить</button>
          <button id="autoScrollBtn" class="log-btn">Автоскролл</button>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">Инвентарь</div>
      
      <div class="inventory" id="inventory"></div>
      
      <div class="action-buttons">
        <div style="display: flex; gap: 8px; width: 100%;">
          <button id="toggleTrade" class="btn btn-secondary">Торговля</button>
          <button id="toggleRecycle" class="btn btn-secondary">Переработка</button>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">Системные апгрейды</div>
      
      <div class="upgrade-container">
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">Эффективность добычи</div>
            <div class="upgrade-level">Ур. <span id="miningLevel">0</span>/10</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" id="miningProgress" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">🎛️</div>
                <span>Чипы:</span>
              </div>
              <div class="requirement-value" id="miningChipsReq">0/5</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeMiningBtn" class="upgrade-btn">Улучшить</button>
          </div>
        </div>
        
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">Туррели защиты</div>
            <div class="upgrade-level" id="defenseStatus">Неактивно</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">💾</div>
                <span>Электроника:</span>
              </div>
              <div class="requirement-value" id="defenseElectronicsReq">0/3</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeDefenseBtn" class="upgrade-btn">Активировать</button>
          </div>
        </div>
        
        <div class="upgrade-card">
          <div class="upgrade-header">
            <div class="upgrade-title">Укрепление защиты</div>
            <div class="upgrade-level" id="defenseLevel">Ур. 0/5</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
          
          <div class="upgrade-requirements">
            <div class="requirement">
              <div class="requirement-name">
                <div class="requirement-icon">🎛️</div>
                <span>Чипы:</span>
              </div>
              <div class="requirement-value" id="defenseChipsReq">0/10</div>
            </div>
          </div>
          
          <div class="upgrade-cost">
            <button id="upgradeDefenseLevelBtn" class="upgrade-btn">Улучшить</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-title">Задания</div>
      <div class="quest-container" id="questsContainer">
        <!-- Квесты будут добавляться динамически -->
      </div>
    </div>
  </div>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Конфигурация игры
      const STORAGE_KEY = 'coreboxSave2.8';
      const maxSlots = 9;
      
      // Состояние игры
      const inventory = { 
        'ИИ': 1, 
        'Уголь': 0, 
        'Мусор': 0,
        'Чипы': 0,
        'Электроника': 0
      };
      
      const upgrades = {
        mining: 0,
        defense: false,
        defenseLevel: 0
      };
      
      let tng = 0;
      let coalEnabled = false;
      let gameTime = 30;
      let isDay = true;
      let passiveCounter = 0;
      let sellMode = false;
      let recycleMode = false;
      let trashSold = 0;
      let criticalMining = false;
      let autoScrollEnabled = true;
      let quests = [];
      let rebelActivity = 0;
      let lastUpdateTime = Date.now();

      // DOM элементы
      const currencyDisplay = document.getElementById('currencyDisplay');
      const timeDisplay = document.getElementById('timeDisplay');
      const defenseDisplay = document.getElementById('defenseDisplay');
      const logBox = document.getElementById('logBox');
      const inventoryDiv = document.getElementById('inventory');
      const aiStatusText = document.getElementById('aiStatusText');
      const coalStatus = document.getElementById('coalStatus');
      const rebelStatus = document.getElementById('rebelStatus');
      const mineBtn = document.getElementById('mineBtn');
      const miningBonusSpan = document.getElementById('miningBonus');
      const toggleTradeBtn = document.getElementById('toggleTrade');
      const toggleRecycleBtn = document.getElementById('toggleRecycle');
      const miningLevel = document.getElementById('miningLevel');
      const miningProgress = document.getElementById('miningProgress');
      const upgradeMiningBtn = document.getElementById('upgradeMiningBtn');
      const defenseStatus = document.getElementById('defenseStatus');
      const upgradeDefenseBtn = document.getElementById('upgradeDefenseBtn');
      const defenseLevel = document.getElementById('defenseLevel');
      const upgradeDefenseLevelBtn = document.getElementById('upgradeDefenseLevelBtn');
      const miningChipsReq = document.getElementById('miningChipsReq');
      const defenseElectronicsReq = document.getElementById('defenseElectronicsReq');
      const defenseChipsReq = document.getElementById('defenseChipsReq');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const autoScrollBtn = document.getElementById('autoScrollBtn');
      const questsContainer = document.getElementById('questsContainer');

      // Вспомогательные функции
      function log(message) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `> ${message}`;
        logBox.appendChild(entry);
        
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
      }
      
      function updateTimeDisplay() {
        const icon = isDay ? '☀️' : '🌙';
        timeDisplay.textContent = `${isDay ? 'День' : 'Ночь'} ${icon} (${gameTime}s)`;
      }

      function updateCurrencyDisplay() {
        currencyDisplay.textContent = `${tng}₸`;
      }
      
      function updateDefenseDisplay() {
        const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
        defenseDisplay.textContent = `${defensePower}%`;
      }

      // Система сохранения
      function saveGame() {
        const saveData = {
          inventory,
          tng,
          coalEnabled,
          gameTime,
          isDay,
          passiveCounter,
          sellMode,
          recycleMode,
          trashSold,
          upgrades,
          autoScrollEnabled,
          quests,
          rebelActivity,
          lastUpdateTime: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
      }

      function loadGame() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            Object.keys(inventory).forEach(key => {
              if (data.inventory[key] !== undefined) inventory[key] = data.inventory[key];
            });
            tng = data.tng ?? 0;
            coalEnabled = data.coalEnabled ?? false;
            gameTime = data.gameTime ?? 30;
            isDay = data.isDay ?? true;
            passiveCounter = data.passiveCounter ?? 0;
            sellMode = data.sellMode ?? false;
            recycleMode = data.recycleMode ?? false;
            trashSold = data.trashSold ?? 0;
            upgrades.mining = data.upgrades?.mining ?? 0;
            upgrades.defense = data.upgrades?.defense ?? false;
            upgrades.defenseLevel = data.upgrades?.defenseLevel ?? 0;
            autoScrollEnabled = data.autoScrollEnabled ?? true;
            quests = data.quests ?? [];
            rebelActivity = data.rebelActivity ?? 0;
            lastUpdateTime = data.lastUpdateTime ?? Date.now();
          } catch (e) {
            console.error('Ошибка загрузки сохранения', e);
          }
        }
      }

      // Игровая логика
      function calculateTrashPrice() {
        const basePrice = 1;
        const priceDrop = Math.floor(trashSold / 5) * 0.05;
        return Math.max(basePrice - priceDrop, 0.3);
      }

      function render() {
        // Обновляем бонус добычи
        miningBonusSpan.textContent = `+${upgrades.mining}%`;
        miningLevel.textContent = upgrades.mining;
        miningProgress.style.width = `${upgrades.mining * 10}%`;
        
        // Обновляем статусы
        coalStatus.textContent = coalEnabled ? 'Активно' : 'Выкл';
        defenseStatus.textContent = upgrades.defense ? 'Активно' : 'Выкл';
        defenseLevel.textContent = `Ур. ${upgrades.defenseLevel}/5`;
        
        // Обновляем статус повстанцев
        let rebelText = 'Низкий';
        let rebelColor = '#00cc66';
        if (rebelActivity > 2) {
          rebelText = 'Высокий';
          rebelColor = '#ff3333';
        } else if (rebelActivity > 0) {
          rebelText = 'Средний';
          rebelColor = '#ffcc00';
        }
        rebelStatus.textContent = rebelText;
        rebelStatus.style.color = rebelColor;
        
        // Обновляем статус ИИ
        // ИСПРАВЛЕНИЕ БАГА: Активность ИИ теперь зависит только от времени суток и состояния ТЭЦ
        const aiActive = isDay || coalEnabled;
        aiStatusText.textContent = aiActive ? 'Активен' : 'Неактивен';
        aiStatusText.style.color = aiActive ? '#00cc66' : '#ff3333';
        
        // Обновляем валюту и защиту
        updateCurrencyDisplay();
        updateDefenseDisplay();
        updateTimeDisplay();
        
        // Обновляем кнопки апгрейдов
        upgradeMiningBtn.disabled = upgrades.mining >= 10 || inventory['Чипы'] < 5;
        upgradeDefenseBtn.disabled = upgrades.defense || inventory['Электроника'] < 3;
        upgradeDefenseLevelBtn.disabled = upgrades.defenseLevel >= 5 || inventory['Чипы'] < (upgrades.defenseLevel + 1) * 10;
        
        // Обновляем требования
        miningChipsReq.textContent = `${inventory['Чипы']}/5`;
        miningChipsReq.className = inventory['Чипы'] >= 5 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defenseElectronicsReq.textContent = `${inventory['Электроника']}/3`;
        defenseElectronicsReq.className = inventory['Электроника'] >= 3 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        defenseChipsReq.textContent = `${inventory['Чипы']}/${(upgrades.defenseLevel + 1) * 10}`;
        defenseChipsReq.className = inventory['Чипы'] >= (upgrades.defenseLevel + 1) * 10 ? 
          'requirement-value requirement-met' : 'requirement-value requirement-not-met';
        
        // Обновляем кнопку автоскролла
        autoScrollBtn.textContent = autoScrollEnabled ? 'Автоскролл ✓' : 'Автоскролл';
        
        // Очищаем инвентарь
        inventoryDiv.innerHTML = '';

        // Отрисовка инвентаря
        Object.entries(inventory).forEach(([name, count]) => {
          if (name === 'ИИ') return;
          
          const slot = document.createElement('div');
          slot.className = 'slot';
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'item-name';
          nameDiv.textContent = name;
          
          const countDiv = document.createElement('div');
          countDiv.className = 'item-count';
          countDiv.textContent = `x${count}`;
          
          slot.appendChild(nameDiv);
          slot.appendChild(countDiv);

          // Анимация для критической добычи
          if (criticalMining && (name === 'Уголь' || name === 'Электроника')) {
            slot.classList.add('critical');
            criticalMining = false;
          }
          
          // Бонусы добычи
          if (name === 'Уголь' || name === 'Мусор') {
            const bonusDiv = document.createElement('div');
            bonusDiv.className = 'mining-bonus';
            const baseChance = name === 'Уголь' ? 3 : 1.5;
            const totalBonus = upgrades.mining + (coalEnabled ? (name === 'Уголь' ? 2 : 1) : 0);
            bonusDiv.textContent = `+${baseChance + totalBonus}%`;
            slot.appendChild(bonusDiv);
          }

          // Режим продажи
          if (sellMode && name === 'Мусор') {
            slot.classList.add('sell-mode');
            slot.onclick = () => handleSellTrash();
          } 
          // Режим переработки
          else if (recycleMode && name === 'Мусор') {
            slot.classList.add('recycle-mode');
            slot.onclick = () => handleRecycleTrash();
          }
          // Уголь
          else if (name === 'Уголь') {
            if (coalEnabled) {
              slot.style.borderColor = 'var(--primary)';
              slot.style.boxShadow = '0 0 8px var(--primary)';
            }
            
            slot.onclick = () => handleCoalInteraction();
          }
          // Электроника для защиты
          else if (name === 'Электроника' && count > 0) {
            slot.classList.add('defense');
          }

          inventoryDiv.appendChild(slot);
        });

        // Заполнение пустых слотов
        while (inventoryDiv.children.length < maxSlots) {
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.innerHTML = '<div class="item-name">[Пусто]</div><div class="item-count">+</div>';
          inventoryDiv.appendChild(slot);
        }
        
        // Отрисовка квестов
        renderQuests();
      }
      
      function renderQuests() {
        questsContainer.innerHTML = '';
        
        if (quests.length === 0) {
          const emptyQuest = document.createElement('div');
          emptyQuest.className = 'quest-card';
          emptyQuest.innerHTML = `
            <div class="quest-description">
              Задания отсутствуют. Продолжайте добычу ресурсов для получения заданий.
            </div>
          `;
          questsContainer.appendChild(emptyQuest);
          return;
        }
        
        quests.forEach(quest => {
          const questCard = document.createElement('div');
          questCard.className = 'quest-card';
          
          const progressPercent = Math.min(100, (quest.progress / quest.target) * 100);
          
          questCard.innerHTML = `
            <div class="quest-header">
              <div class="quest-title">${quest.title}</div>
              <div class="quest-reward">${quest.reward}₸</div>
            </div>
            <div class="quest-progress-container">
              <div class="quest-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="quest-description">
              ${quest.description}<br>
              Прогресс: ${quest.progress}/${quest.target}
            </div>
          `;
          
          questsContainer.appendChild(questCard);
        });
      }
      
      function checkQuests() {
        quests.forEach(quest => {
          if (quest.completed) return;
          
          // Проверка выполнения квеста
          if (quest.type === 'mine') {
            if (quest.progress >= quest.target) {
              completeQuest(quest.id);
            }
          }
          else if (quest.type === 'sell') {
            if (inventory['Мусор'] >= quest.target) {
              completeQuest(quest.id);
            }
          }
          else if (quest.type === 'upgrade') {
            if (upgrades.mining >= quest.target) {
              completeQuest(quest.id);
            }
          }
        });
      }
      
      function completeQuest(questId) {
        const questIndex = quests.findIndex(q => q.id === questId);
        if (questIndex !== -1) {
          const quest = quests[questIndex];
          tng += quest.reward;
          quest.completed = true;
          
          log(`✅ Задание "${quest.title}" выполнено! +${quest.reward}₸`);
          quests.splice(questIndex, 1);
          
          // Создаем новое задание
          generateNewQuest();
          
          updateCurrencyDisplay();
          saveGame();
          render();
        }
      }
      
      function generateNewQuest() {
        if (quests.length >= 3) return;
        
        const questTypes = ['mine', 'sell', 'upgrade'];
        const type = questTypes[Math.floor(Math.random() * questTypes.length)];
        
        let quest;
        switch(type) {
          case 'mine':
            const resources = ['Уголь', 'Мусор', 'Чипы', 'Электроника'];
            const resource = resources[Math.floor(Math.random() * resources.length)];
            const target = Math.max(3, Math.floor(Math.random() * 10) + 3);
            
            quest = {
              id: `mine_${Date.now()}`,
              title: 'Добыть ресурсы',
              description: `Добыть ${target} ${resource}`,
              type: 'mine',
              resource: resource,
              target: target,
              progress: inventory[resource] || 0,
              reward: target * 2,
              completed: false
            };
            break;
            
          case 'sell':
            const sellTarget = Math.max(5, Math.floor(Math.random() * 15) + 5);
            
            quest = {
              id: `sell_${Date.now()}`,
              title: 'Продать мусор',
              description: `Продать ${sellTarget} мусора за один раз`,
              type: 'sell',
              target: sellTarget,
              progress: 0,
              reward: sellTarget * 1.5,
              completed: false
            };
            break;
            
          case 'upgrade':
            const upgradeTarget = Math.min(10, Math.max(1, upgrades.mining + Math.floor(Math.random() * 2) + 1));
            
            quest = {
              id: `upgrade_${Date.now()}`,
              title: 'Улучшить добычу',
              description: `Улучшить эффективность добычи до уровня ${upgradeTarget}`,
              type: 'upgrade',
              target: upgradeTarget,
              progress: upgrades.mining,
              reward: upgradeTarget * 5,
              completed: false
            };
            break;
        }
        
        quests.push(quest);
        log(`🆕 Получено новое задание: ${quest.title}`);
      }
      
      function handleRebelAttack() {
        // Уровень угрозы зависит от активности повстанцев
        const threatLevel = Math.min(1, rebelActivity * 0.2);
        
        if (Math.random() < threatLevel) {
          // Определяем тип атаки
          const attackType = Math.floor(Math.random() * 3);
          let message = "🌙 Повстанцы атаковали!";
          
          switch(attackType) {
            case 0: // Кража ресурсов
              const resources = Object.keys(inventory).filter(k => k !== 'ИИ' && inventory[k] > 0);
              if (resources.length > 0) {
                const stolenResource = resources[Math.floor(Math.random() * resources.length)];
                const amount = Math.min(inventory[stolenResource], Math.floor(Math.random() * 3) + 1);
                inventory[stolenResource] -= amount;
                message += ` Украдено ${amount} ${stolenResource}`;
              }
              break;
              
            case 1: // Повреждение оборудования
              if (upgrades.mining > 0 && Math.random() < 0.3) {
                upgrades.mining--;
                message += " Повреждена система добычи! Уровень понижен";
              }
              break;
              
            case 2: // Вандализм
              if (inventory['Мусор'] > 0) {
                const destroyed = Math.min(inventory['Мусор'], Math.floor(Math.random() * 5) + 3);
                inventory['Мусор'] -= destroyed;
                message += ` Уничтожено ${destroyed} мусора`;
              }
              break;
          }
          
          log(message);
          rebelActivity++;
          saveGame();
        }
      }

      // Обработчики взаимодействий
      function handleSellTrash() {
        if (inventory['Мусор'] > 0) {
          const price = calculateTrashPrice();
          const earned = Math.floor(inventory['Мусор'] * price);
          tng += earned;
          trashSold += inventory['Мусор'];
          
          // Проверяем квесты на продажу
          quests.forEach(quest => {
            if (quest.type === 'sell' && inventory['Мусор'] >= quest.target) {
              quest.progress = inventory['Мусор'];
            }
          });
          
          log(`Продано ${inventory['Мусор']} мусора +${earned}₸`);
          inventory['Мусор'] = 0;
          updateCurrencyDisplay();
          saveGame();
          render();
          checkQuests();
        }
      }

      function handleRecycleTrash() {
        if (inventory['Мусор'] >= 5) {
          inventory['Мусор'] -= 5;
          inventory['Уголь']++;
          
          log('Переработано 5 мусора → 1 уголь');
          saveGame();
          render();
        }
      }

      function handleCoalInteraction() {
        if (sellMode && isDay) {
          if (inventory['Уголь'] > 0) {
            inventory['Уголь']--;
            tng += 3;
            coalEnabled = false;
            
            log('Продано 1 уголь +3₸ (ТЭЦ отключена)');
            updateCurrencyDisplay();
            saveGame();
            render();
          }
        } 
        else if (!sellMode && !recycleMode) {
          if (!coalEnabled) {
            if (inventory['Уголь'] > 0) {
              coalEnabled = true;
              inventory['Уголь']--;
              
              log('Угольная ТЭЦ активирована (-1 уголь)');
            } else {
              log('Нет угля для активации!');
            }
          } else {
            coalEnabled = false;
            log('Угольная ТЭЦ отключена');
          }
          saveGame();
          render();
        }
      }

      function mineResources() {
        // ИСПРАВЛЕНИЕ: Теперь активность ИИ зависит только от времени суток и состояния ТЭЦ
        const aiActive = isDay || coalEnabled;
        if (!aiActive) {
          log('❌ ИИ неактивен! Нужна энергия');
          return;
        }
        
        // Увеличенная сложность добычи
        const coalChance = 0.02 + (coalEnabled ? 0.02 : 0) + (upgrades.mining * 0.01);
        const trashChance = 0.01 + (coalEnabled ? 0.01 : 0) + (upgrades.mining * 0.01);
        const chipChance = 0.005;
        const electronicsChance = 0.003;
        const isCritical = Math.random() < 0.05;

        let foundSomething = false;

        if (Math.random() < coalChance) {
          const amount = isCritical ? 2 : 1;
          inventory['Уголь'] += amount;
          criticalMining = isCritical;
          
          log(`Найден${amount > 1 ? 'о' : ''} ${amount} угля 🪨${isCritical ? ' ✨' : ''}`);
          foundSomething = true;
          
          // Обновляем квесты на добычу угля
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === 'Уголь') {
              quest.progress += amount;
            }
          });
        }
        
        if (Math.random() < trashChance) {
          inventory['Мусор']++;
          log('Найден мусор ♻️');
          foundSomething = true;
          
          // Обновляем квесты на добычу мусора
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === 'Мусор') {
              quest.progress++;
            }
          });
        }
        
        if (Math.random() < chipChance) {
          inventory['Чипы']++;
          criticalMining = true;
          log('Найден чип 🎛️✨');
          foundSomething = true;
          
          // Обновляем квесты на добычу чипов
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === 'Чипы') {
              quest.progress++;
            }
          });
        }
        
        if (Math.random() < electronicsChance) {
          inventory['Электроника']++;
          criticalMining = true;
          log('Найдена электроника 💾✨');
          foundSomething = true;
          
          // Обновляем квесты на добычу электроники
          quests.forEach(quest => {
            if (quest.type === 'mine' && quest.resource === 'Электроника') {
              quest.progress++;
            }
          });
        }
        
        saveGame();
        render();
        checkQuests();
      }
      
      function upgradeMining() {
        if (upgrades.mining < 10 && inventory['Чипы'] >= 5) {
          inventory['Чипы'] -= 5;
          upgrades.mining++;
          
          log(`Улучшена добыча! Теперь +${upgrades.mining}% к шансам`);
          
          // Обновляем квесты на апгрейды
          quests.forEach(quest => {
            if (quest.type === 'upgrade') {
              quest.progress = upgrades.mining;
            }
          });
          
          saveGame();
          render();
          checkQuests();
        }
      }
      
      function activateDefense() {
        if (!upgrades.defense && inventory['Электроника'] >= 3) {
          inventory['Электроника'] -= 3;
          upgrades.defense = true;
          
          log('Активированы туррели защиты!');
          saveGame();
          render();
        }
      }
      
      function upgradeDefense() {
        if (upgrades.defenseLevel < 5 && inventory['Чипы'] >= (upgrades.defenseLevel + 1) * 10) {
          const cost = (upgrades.defenseLevel + 1) * 10;
          inventory['Чипы'] -= cost;
          upgrades.defenseLevel++;
          
          log(`Улучшена защита до уровня ${upgrades.defenseLevel}!`);
          saveGame();
          render();
        }
      }
      
      function clearLog() {
        logBox.innerHTML = '<div class="log-controls"><button id="clearLogBtn" class="log-btn">Очистить</button><button id="autoScrollBtn" class="log-btn">Автоскролл</button></div>';
        log('Журнал очищен');
      }
      
      function toggleAutoScroll() {
        autoScrollEnabled = !autoScrollEnabled;
        if (autoScrollEnabled) {
          logBox.scrollTop = logBox.scrollHeight;
        }
        saveGame();
        render();
      }

      // Игровой цикл
      function gameLoop() {
        const now = Date.now();
        const secondsPassed = Math.floor((now - lastUpdateTime) / 1000);
        lastUpdateTime = now;
        
        // Обновляем игровое время с учетом прошедших секунд
        gameTime -= secondsPassed;
        
        while (gameTime <= 0) {
          gameTime += 30;
          isDay = !isDay;
          
          if (!isDay) {
            if (coalEnabled) {
              if (inventory['Уголь'] > 0) {
                inventory['Уголь']--;
                log('🌙 Ночь - сгорел 1 уголь');
              } else {
                coalEnabled = false;
                log('🌙 Ночь - уголь закончился, ТЭЦ отключена');
              }
            }
            
            // Атака повстанцев
            if (!isDay) {
              const defensePower = upgrades.defense ? 30 + (upgrades.defenseLevel * 15) : 0;
              if (Math.random() * 100 > defensePower) {
                handleRebelAttack();
              } else if (upgrades.defense) {
                log('🌙 Система защиты отразила атаку повстанцев');
              }
              
              // Увеличиваем активность повстанцев
              if (Math.random() < 0.3) {
                rebelActivity++;
              }
            }
          } else {
            // Снижаем активность повстанцев днем
            rebelActivity = Math.max(0, rebelActivity - 1);
          }
          
          log(isDay ? '☀️ Наступил день' : '🌙 Наступила ночь');
          
          // Генерация новых квестов при смене дня
          if (isDay && quests.length < 3 && Math.random() < 0.5) {
            generateNewQuest();
          }
          
          saveGame();
        }

        // Пассивный доход (с учетом прошедших секунд)
        passiveCounter += secondsPassed;
        while (passiveCounter >= 10) {
          passiveCounter -= 10;
          // ИСПРАВЛЕНИЕ: Активность ИИ теперь зависит только от времени суток и состояния ТЭЦ
          const aiActive = isDay || coalEnabled;
          if (aiActive) {
            const coalChance = 0.003 + (upgrades.mining * 0.001);
            const trashChance = 0.007 + (upgrades.mining * 0.001);
            const chipChance = 0.001;
            const electronicsChance = 0.0005;
            
            if (Math.random() < coalChance) {
              inventory['Уголь']++;
            }
            if (Math.random() < trashChance) {
              inventory['Мусор']++;
            }
            if (Math.random() < chipChance) {
              inventory['Чипы']++;
            }
            if (Math.random() < electronicsChance) {
              inventory['Электроника']++;
            }
            
            saveGame();
          }
        }

        render();
      }

      // Инициализация игры
      function initEventListeners() {
        mineBtn.addEventListener('click', mineResources);
        toggleTradeBtn.addEventListener('click', toggleTradeMode);
        toggleRecycleBtn.addEventListener('click', toggleRecycleMode);
        upgradeMiningBtn.addEventListener('click', upgradeMining);
        upgradeDefenseBtn.addEventListener('click', activateDefense);
        upgradeDefenseLevelBtn.addEventListener('click', upgradeDefense);
        clearLogBtn.addEventListener('click', clearLog);
        autoScrollBtn.addEventListener('click', toggleAutoScroll);
      }

      function toggleTradeMode() {
        sellMode = !sellMode;
        if (sellMode) recycleMode = false;
        log(sellMode ? 'Активирован режим торговли' : 'Режим торговли отключен');
        saveGame();
        render();
      }

      function toggleRecycleMode() {
        recycleMode = !recycleMode;
        if (recycleMode) sellMode = false;
        log(recycleMode ? 'Активирован режим переработки' : 'Режим переработки отключен');
        saveGame();
        render();
      }

      // Запуск игры
      function initGame() {
        loadGame();
        initEventListeners();
        
        // Генерация начальных квестов
        if (quests.length === 0) {
          generateNewQuest();
          generateNewQuest();
        }
        
        render();
        
        // Инициализация игрового цикла
        setInterval(gameLoop, 1000);
        
        log('Система CoreBox 2.8 инициализирована');
        log('Добро пожаловать в систему добычи ресурсов!');
        log('Остерегайтесь повстанцев-анархистов по ночам!');
      }

      initGame();
    });
  </script>
</body>
</html>